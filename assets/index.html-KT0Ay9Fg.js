import{_ as i,c as a,e as l,o as n}from"./app-D5peQ_E2.js";const e="/images/CF73043D4E92439A8F92CC6B937B6AB3clipboard.png",p="/images/97549FF2AF58428EA2A5684C48153052clipboard.png",t="/images/56F56B2D53AC4FAB83088615376A5720clipboard.png",h="/images/C5A801E6B7A84C39A42B57A158172029clipboard.png",k="/images/4F2E70888DF042E797024352C3D5E5EAclipboard.png",r="/images/2B032000314E4C80BCA651C8FD2B83D5clipboard.png",d="/images/B9386F315D434B56A0406E9DBEE40414clipboard.png",c="/images/C0AB7281B6324798840833AF5AF4B88Bclipboard.png",g="/images/130E9C7374BD421C81F4C4882C1CB93Cclipboard.png",A="/images/3696E1B7014849EF94335658C09A15C6clipboard.png",y="/images/03ABE34358714138A3E1E3B146A3AA20clipboard.png",o="/images/E8E29475D9EB4E6BA6A1F11B65CE7D2Cclipboard.png",v="/images/543879804CF04A2EAF15509904A62A9Eclipboard.png",u="/images/C31EEB76852B48C98F86C18885A56576clipboard.png",m="/images/E1BBAA9498D24E019DDE045649A3ADBBclipboard.png",D="/images/6926700A02404FB6B29E6B2B5A20ADECclipboard.png",B="/images/F6B490280E3F405986346EF4426185CBclipboard.png",b="/images/9EB6C2B5C2D84DC6A2593C66EE25F3E5clipboard.png",C="/images/CF412AFC16BE4D87891F6104CB7F0F5Aclipboard.png",E="/images/C79A0E385FAE42D28182674C1412A8C3clipboard.png",_="/images/478535722F1A4126AE64F077CC4E9F29clipboard.png",S="/images/2D7C6A7C67D14F698D466688DBBDCF9Fclipboard.png",f={};function w(x,s){return n(),a("div",null,s[0]||(s[0]=[l('<h2 id="从运维角度看微服务" tabindex="-1"><a class="header-anchor" href="#从运维角度看微服务"><span>从运维角度看微服务</span></a></h2><h3 id="单体应用-vs-微服务" tabindex="-1"><a class="header-anchor" href="#单体应用-vs-微服务"><span>单体应用 vs 微服务</span></a></h3><p><img src="'+e+'" alt=""></p><p>特点：</p><ul><li><p>易于部署</p></li><li><p>易于测试</p></li></ul><p>不足：</p><ul><li><p>代码膨胀，难以维护</p></li><li><p>构建、部署成本大</p></li><li><p>新人上手难</p></li></ul><p><img src="'+p+'" alt=""></p><h3 id="微服务特点" tabindex="-1"><a class="header-anchor" href="#微服务特点"><span>微服务特点</span></a></h3><p>服务组件化</p><p>每个服务独立开发、部署，有效避免一个服务的修改引起整个系统重新部署。</p><p>技术栈灵活</p><p>约定通信方式，使得服务本身功能实现对技术要求不再那么敏感。</p><p>独立部署</p><p>每个微服务独立部署，加快部署速度，方便扩展。</p><p>扩展性强</p><p>每个微服务可以部署多个，并且有负载均衡能力。</p><p>独立数据</p><p>每个微服务有独立的基本组件，例如数据库、缓存等。</p><h3 id="微服务不足" tabindex="-1"><a class="header-anchor" href="#微服务不足"><span>微服务不足</span></a></h3><ul><li><p>沟通成本</p></li><li><p>数据一致性</p></li><li><p>运维成本：部署、监控</p></li><li><p>内部架构复杂性</p></li><li><p>大量服务治理</p></li></ul><h3 id="java微服务框架" tabindex="-1"><a class="header-anchor" href="#java微服务框架"><span>Java微服务框架</span></a></h3><ul><li><p>Spring Boot：快速开发微服务的框架</p></li><li><p>Spring Cloud：基于SpringBoot实现的一个完整的微服务解决方案</p></li><li><p>Dubbo：阿里巴巴开源的微服务治理框架</p></li></ul><h2 id="在k8s平台部署微服务考虑的问题" tabindex="-1"><a class="header-anchor" href="#在k8s平台部署微服务考虑的问题"><span>在K8s平台部署微服务考虑的问题</span></a></h2><h3 id="常见微服务架构图" tabindex="-1"><a class="header-anchor" href="#常见微服务架构图"><span>常见微服务架构图</span></a></h3><p><img src="'+t+'" alt=""></p><h3 id="对微服务项目架构理解" tabindex="-1"><a class="header-anchor" href="#对微服务项目架构理解"><span>对微服务项目架构理解</span></a></h3><ul><li><p>微服务间如何通信？REST API，RPC，MQ</p></li><li><p>微服务如何发现彼此？注册中心</p></li><li><p>组件之间怎么个调用关系？</p></li><li><p>哪个服务作为整个网站入口？前后端分离</p></li><li><p>哪些微服务需要对外访问？前端和微服务网关</p></li><li><p>微服务怎么部署？更新？扩容？</p></li><li><p>区分有状态应用与无状态应用</p></li></ul><h3 id="为什么用注册中心系统" tabindex="-1"><a class="header-anchor" href="#为什么用注册中心系统"><span>为什么用注册中心系统</span></a></h3><p>微服务太多面临的问题：</p><ul><li><p>怎么记录一个微服务多个副本接口地址？</p></li><li><p>怎么实现一个微服务多个副本负载均衡？</p></li><li><p>怎么判断一个微服务副本是否可用？</p></li></ul><p>主流注册中心：Eureka，Nacos，Consul</p><p><img src="'+h+'" alt=""></p><h3 id="在k8s部署项目流程" tabindex="-1"><a class="header-anchor" href="#在k8s部署项目流程"><span>在K8s部署项目流程</span></a></h3><p><img src="'+k+'" alt=""></p><h2 id="在k8s平台部署spring-cloud微服务项目" tabindex="-1"><a class="header-anchor" href="#在k8s平台部署spring-cloud微服务项目"><span>在K8S平台部署Spring Cloud微服务项目</span></a></h2><h3 id="容器化微服务项目实施步骤" tabindex="-1"><a class="header-anchor" href="#容器化微服务项目实施步骤"><span>容器化微服务项目实施步骤</span></a></h3><p>具体步骤：</p><p>第一步：熟悉Spring Cloud微服务项目</p><p>第二步：源代码编译构建</p><p>第三步：构建项目镜像并推送到镜像仓库</p><p>第四步：K8s服务编排</p><p>第五步：在K8s中部署Eureka集群（注册中心）和MySQL数据库</p><p>第六步：部署微服务网关服务</p><p>第七步：部署微服务业务程序</p><p>第八步：部署微服务前端</p><p>第九步：微服务对外发布</p><p>第十步：微服务升级与扩容</p><p>第一步：熟悉Spring Cloud微服务项目</p><p><img src="'+r+'" alt=""></p><p>https://gitee.com/lucky_liuzhe/simple-microservice</p><p>代码分支说明：</p><ul><li><p>dev1 交付代码</p></li><li><p>dev2 增加Dockerfile</p></li><li><p>dev3 增加K8s资源编排</p></li><li><p>dev4 增加APM监控系统</p></li><li><p>master 最终上线</p></li></ul><p><img src="'+d+`" alt=""></p><p>第二步：源代码编译构建</p><p>Maven项目对象模型(POM)，可以通过一小段描述信息来管理项目的构建，报告和文档的项目管 理工具软件。</p><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">yum</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> install</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> java-1.8.0-openjdk</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> maven</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -y</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">修改maven源：https://maven.aliyun.com/mvn/guide</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">mvn</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> clean</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> package</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -Dmaven.test.skip=true</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>第三步：构建项目镜像并推送到镜像仓库</p><p><img src="`+c+`" alt=""></p><p>Dockerfile文件更换apk阿里云源</p><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">链接：https://blog.csdn.net/qq_33657251/article/details/107526842</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">sed</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -i</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">s/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/apk/repositories</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> &amp;&amp;</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \\</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#使用sed工具将字符串dl-cdn.alpinelinux.org替换为mirrors.aliyun.com</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>第四步：K8s服务编排</p><p><img src="`+g+`" alt=""></p><p>第五步：在K8s中部署Erureka集群和MySQL数据库</p><p>1.删除Dockerfile中运行的拷贝时区的命令</p><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">find</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> .</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -name</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> Dockerfile</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> xargs</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -i</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> sed</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -i</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">/RUN/d</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {}</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">find</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> .</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -name</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> Dockerfile</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> xargs</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -i</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> sed</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -i</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">/ln/d</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="`+A+`" alt=""></p><p>2.修改源代码中eureka配置文件：</p><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># cat eureka-service/src/main/resources/application-fat.yml</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">eureka:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  server:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    renewal-percent-threshold:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 0.9</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    enable-self-preservation:</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> false</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    eviction-interval-timer-in-ms:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 40000</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  instance:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    hostname:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 127.0.0.1</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    prefer-ip-address:</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> false</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">     #使用ip去通信，默认是使用主机名</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  client:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    register-with-eureka:</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> true</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    serviceUrl:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">      defaultZone:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> http://eureka-0.eureka.ms:</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">\${</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">server</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">port</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">/eureka/,http://eureka-1.eureka.ms:</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">\${</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">server</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">port</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">/eureka/,http://eureka-2.eureka.ms:</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">\${</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">server</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">port</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">/eureka/</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    fetch-registry:</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> true</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>prefer-ip-address: false 由于使用statefulset部署默认使用主机名通信，其他微服务使用deployment部署无法使用主机名通信，dns无法解析，所以修改为使用IP去通信。</p><p>Eureka集群节点Pod DNS名称：</p><p>http://eureka-0.eureka.ms.svc.cluster.local</p><p>http://eureka-1.eureka.ms.svc.cluster.local</p><p>http://eureka-2.eureka.ms.svc.cluster.local</p><p>3.修改docker_build.sh 文件</p><p>修改镜像仓库地址，要推送的镜像仓库项目名</p><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#vi docker_build.sh </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#!/bin/bash</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">docker_registry</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">192.168.0.14</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> create</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> secret</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> docker-registry</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> registry-pull-secret</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --docker-server=</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">$docker_registry</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --docker-username=admin</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --docker-password=Harbor12345</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --docker-email=admin@ctnrs.com</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -n</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ms</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">service_list</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">eureka-service gateway-service order-service product-service stock-service portal-service</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">service_list</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">\${1</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:-</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">\${</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">service_list</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">}</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">work_dir</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=$(</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">dirname</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> $PWD</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">current_dir</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">$PWD</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">cd</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> $work_dir</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">mvn</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> clean</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> package</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -Dmaven.test.skip=true</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">for</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> service</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> in</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> $service_list</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> do</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">   cd</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> $work_dir</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">/</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">$service</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">   if</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> ls</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">grep</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> biz</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> &amp;</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">&gt;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">/dev/null</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> then</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">      cd</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> \${</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">service</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">-biz</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">   fi</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">   service</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=\${</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">service</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">%</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">-</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">*</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">   image_name</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">$docker_registry</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">/ms/</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">\${</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">service</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">:</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">$(</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">date</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> +%F-%H-%M-%S</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">   docker</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> build</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -t</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> \${</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">image_name</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> .</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">   docker</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> push</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> \${</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">image_name</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">   sed</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -i</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -r</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">s#(image: )(.*)#\\1$image_name#</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> \${</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">current_dir</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">/</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">\${</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">service</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">.yaml</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">   kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> apply</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -f</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> \${</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">current_dir</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">/</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">\${</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">service</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">.yaml</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">done</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>4.创建命名空间并部署eureka服务并启动（记得部署之前要部署ingress控制器）</p><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#创建命名空间</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> create</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ns</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ms</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#启动部署(修改各个微服务yaml文件中的requests，请求资源设置小一点0.2)</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">./docker_build.sh</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> eureka-service</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>5.部署MySQL</p><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#部署MySQL</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> apply</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -f</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> mysql.yaml</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#导入sql文件</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">将源代码里db目录下sql文件拷贝到mysql容器并导入：</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> cp</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> order.sql</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> mysql-68d6f45844-kc6v4:/</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -n</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ms</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> cp</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> product.sql</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> mysql-68d6f45844-kc6v4:/</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -n</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ms</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> cp</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> stock.sql</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> mysql-68d6f45844-kc6v4:/</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -n</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ms</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> exec</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -it</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> mysql-68d6f45844-kc6v4</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -n</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ms</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> bash</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#mysql -u root -p$MYSQL_ROOT_PASSWORD</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">mysql</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">&gt; </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">create</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> database</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> tb_product</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">mysql</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">&gt; </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">use</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> tb_product</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">mysql</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">&gt; </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">source</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /product.sql</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">mysql</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">&gt; </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">create</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> database</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> tb_order</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">mysql</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">&gt; </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">use</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> tb_order</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">mysql</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">&gt; </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">source</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /order.sql</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">mysql</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">&gt; </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">create</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> database</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> tb_stock</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">mysql</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">&gt; </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">use</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> tb_stock</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">mysql</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">&gt; </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">source</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /stock.sql</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>MySQL Service DNS名称：mysql.ms.svc.cluster.local</p><p>第六步至第九步：在K8s中部署微服务</p><ul><li><p>部署业务程序（product、stock、order）</p></li><li><p>部署网关（gateway）</p></li><li><p>部署前端（portal）</p></li></ul><p>修改product、stock、order连接数据库地址</p><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#vi product-service/product-service-biz/src/main/resources/application-fat.yml </span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">url:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> jdbc:mysql://mysql:3306/tb_product?characterEncoding=utf-8</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#其余两个微服务同上操作</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>启动部署</p><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#修改各个微服务yaml文件中的requests，请求资源设置小一点0.2（java太吃内存）</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">cd</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> k8s/</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">./docker_build.sh</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> product-service</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">./docker_build.sh</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> order-service</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">./docker_build.sh</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> stock-service</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">./docker_build.sh</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> gateway-service</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">./docker_build.sh</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> portal-service</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>第十步：微服务升级与扩容</p><p>微服务升级：对要升级的微服务进行上述步骤打包镜像:版本，替代运行的镜像</p><p>微服务扩容：对Pod扩容副本数</p><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> scale</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> deployment</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> product</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --replicas=2</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -n</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ms</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="生产环境踩坑经验分享" tabindex="-1"><a class="header-anchor" href="#生产环境踩坑经验分享"><span>生产环境踩坑经验分享</span></a></h3><p>Q：限制了容器资源，还经常被杀死？</p><p>A：在JAVA1.9版本之前，是不能自动发现docker设置的 内存限制，随着应用负载起伏就会造成内存使用过大， 超过limits限制，从而触发K8s杀掉该容器。</p><p>解决办法：</p><ul><li><p>手动指定JVM堆内存大小</p></li><li><p>配置JVM自动识别（1.9版本+才支持）-</p></li></ul><p>XX:+UnlockExperimentalVMOptions -</p><p>XX:+UseCGroupMemoryLimitForHeap</p><p><img src="`+y+'" alt=""></p><p>Q：滚动更新期间造成流量丢失</p><p>A：滚动更新触发，Pod在删除过程中，有些节点kube-proxy还没来得及同步iptables规则， 从而部分流量请求到Terminating的Pod上，导致请求出错。</p><p>解决办法：配置preStop回调，在容器终止前优雅暂停5秒，给kube-proxy多预留一点时间。</p><p><img src="'+o+'" alt=""></p><p>Q：滚动更新之健康检查重要性</p><p>A：滚动更新是默认发布策略，当配置健康检查时，滚动更新会根据Probe状 态来决定是否继续更新以及是否允许接入流量，这样在整个滚动更新过程中可 保证始终会有可用的Pod存在，达到平滑升级。</p><p><img src="'+v+'" alt=""></p><h2 id="apm监控微服务项目" tabindex="-1"><a class="header-anchor" href="#apm监控微服务项目"><span>APM监控微服务项目</span></a></h2><h3 id="微服务监控需求" tabindex="-1"><a class="header-anchor" href="#微服务监控需求"><span>微服务监控需求</span></a></h3><p>随着微服务架构的流行，服务按照不同的维度进行拆分，一次请求往往需要 涉及到多个服务。这些服务可能不同编程语言开发，不同团队开发，可能部 署很多副本。因此，就需要一些可以帮助理解系统行为、用于分析性能问题 的工具，以便发生故障的时候，能够快速定位和解决问题。“APM系统” 就 在这样的问题背景下产生了。</p><p>APM系统 从整体维度到局部维度展示各项指标，将跨应用的所有调用链性能 信息集中展现，可方便度量整体和局部性能，并且方便找到故障产生的源头， 生产上可极大缩短故障排除时间</p><p><img src="'+u+'" alt=""></p><h3 id="apm监控系统是什么" tabindex="-1"><a class="header-anchor" href="#apm监控系统是什么"><span>APM监控系统是什么</span></a></h3><p>APM（ApplicationPerformance Management）是一种应用性能监控工具，通过汇聚业务系统各处理 环节的实时数据，分析业务系统各事务处理的交易路径和处理时间，实现对应用的全链路性能监测。</p><p>相比接触的Prometheus、Zabbix这类监控系统，APM系统主要监控对应用程序内部，例如：</p><ul><li><p>请求链路追踪：通过分析服务调用关系，绘制运行时拓扑信息，可视化展示</p></li><li><p>调用情况衡量：各个调用环节的性能分析，例如吞吐量、响应时间、错误次数</p></li><li><p>运行情况反馈：告警，通过调用链结合业务日志快速定位错误信息</p></li></ul><h3 id="apm监控系统选择依据" tabindex="-1"><a class="header-anchor" href="#apm监控系统选择依据"><span>APM监控系统选择依据</span></a></h3><p>APM类监控系统有：Skywalking、Pinpoint、Zipkin</p><p>关于选型，可以从以下方面考虑：</p><p>探针的性能消耗</p><p>APM组件服务的影响应该做到足够小，数据分析要快，性能占用小。</p><p>代码的侵入性</p><p>即也作为业务组件，应当尽可能少入侵或者无入侵其他业务系统，对于使用 方透明，减少开发人员的负担。</p><p>监控维度</p><p>分析的维度尽可能多。</p><p>可扩展性</p><p>一个优秀的调用跟踪系统必须支持分布式部署，具备良好的可扩展性。能够 支持的组件越多当然越好。</p><h3 id="skywalking介绍" tabindex="-1"><a class="header-anchor" href="#skywalking介绍"><span>Skywalking介绍</span></a></h3><p>Skywalking 是一个分布式应用程序性能监控系统，针对微服务体系结构而设计。</p><p>功能：</p><ul><li><p>多种监控手段。可以通过语言探针和 service mesh 获得监控是数据。</p></li><li><p>多个语言自动探针。包括 Java，.NET Core 和 Node.JS。</p></li><li><p>轻量高效。无需大数据平台，和大量的服务器资源。</p></li><li><p>模块化。UI、存储、集群管理都有多种机制可选。</p></li><li><p>支持告警。</p></li><li><p>优秀的可视化解决方案。</p></li></ul><h3 id="skywalking架构" tabindex="-1"><a class="header-anchor" href="#skywalking架构"><span>Skywalking架构</span></a></h3><p><img src="'+m+'" alt=""></p><p><img src="'+D+`" alt=""></p><h3 id="skywalking部署" tabindex="-1"><a class="header-anchor" href="#skywalking部署"><span>Skywalking部署</span></a></h3><p>1、部署ES数据库</p><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">docker</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> run</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --name</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> elasticsearch</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -p</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 9200:9200</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -e</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">discovery.type=single-node</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -d</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> elasticsearch:7.7.0</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>2、部署Skywalking OAP</p><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">软件包下载地址：https://archive.apache.org/dist/skywalking/8.3.0/</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">yum</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> install</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> java-11-openjdk</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> –y</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">tar</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> zxvf</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> apache-skywalking-apm-es7-8.3.0.tar.gz</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">cd</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> apache-skywalking-apm-bin-es7/</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>指定数据源：</p><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#vi config/application.yml</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">storage:</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> </span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    selector:</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> \${</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">SW_STORAGE</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">elasticsearch7</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> #这里使用elasticsearch7</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    ...</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    elasticsearch7:</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> </span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        nameSpace:</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> \${</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">SW_NAMESPACE</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> </span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        clusterNodes:</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> \${</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">SW_STORAGE_ES_CLUSTER_NODES</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">192</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">168</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">0</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">10</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">9200</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> # 指定ES地址</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>启动OAP和UI：</p><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">./bin/startup.sh</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>访问UI：http://IP:8080</p><h3 id="微服务接入skywalking监控" tabindex="-1"><a class="header-anchor" href="#微服务接入skywalking监控"><span>微服务接入Skywalking监控</span></a></h3><p>内置Agent包路径：apache-skywalking-apm-bin-es7/agent/</p><p>启动Java程序以探针方式集成Agent：</p><p>java -jar -javaagent:/skywalking/skywalking-agent.jar=agent.service_name=&lt;项目名称 &gt;,agent.instance_name=&lt;实例名称&gt;,collector.backend_service=:11800 xxx.jar</p><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#使用dev4分支部署</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#注意修改的部分：</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">1.修改每个微服务下的Dockerfile中连接Skywalking服务器地址以及application-fat.yml</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">中连接MySQL服务器的地址</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">2.修改docker_build.sh脚本中连接harbor服务器的地址以及推送到镜像仓库的项目名</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="skywalking-ui使用" tabindex="-1"><a class="header-anchor" href="#skywalking-ui使用"><span>Skywalking UI使用</span></a></h3><p><img src="`+B+'" alt=""></p><ul><li><p>第一栏：不同内容主题的监控面板，应用/数据库/容器等</p></li><li><p>第二栏：操作，包括编辑/导出当前数据/倒入展示数据/不同服务端点筛选展示</p></li><li><p>第三栏：不同纬度展示，服务/实例/端点</p></li></ul><p><img src="'+b+'" alt=""></p><p>全局：</p><ul><li><p>Service Load：CPM 每分钟回调次数</p></li><li><p>Slow Services：慢响应服务，单位ms</p></li><li><p>Un-Health Services：不健康的服务，1为满分</p></li><li><p>Slow Endpoints：慢端点，单位ms</p></li><li><p>Global Response Latency：百分比响应延时，不同百分 比的延时时间，单位ms</p></li><li><p>Global Heatmap：服务响应时间热力分布图，根据时间 段内不同响应时间的数量显示颜色深度</p></li><li><p>底部栏：展示数据的时间区间，点击可以调整</p></li></ul><p><img src="'+C+'" alt=""></p><p>Service：</p><ul><li><p>Service Apdex（数字）:当前服务的评分</p></li><li><p>Service Apdex（折线图）：当前服务评分趋势图</p></li><li><p>Service Avg Response Times：服务平均响应时间，单 位ms</p></li><li><p>Service Response Time Percentile：服务响应时间百分 比，单位ms</p></li><li><p>Successful Rate（数字）：请求成功率</p></li><li><p>Successful Rate（折线图）：请求成功率趋势图</p></li><li><p>Servce Load（数字）：每分钟请求数</p></li><li><p>Servce Load（折线图）：每分钟请求数趋势图</p></li><li><p>Servce Instances Load：服务实例的每分钟请求数</p></li><li><p>Slow Service Instance：慢服务实例，单位ms</p></li><li><p>Service Instance Successful Rate：服务实例成功率</p></li></ul><p><img src="'+E+'" alt=""></p><p>Instance：</p><ul><li><p>Service Instance Load：当前实例的每分钟请求数</p></li><li><p>Service Instance Successful Rate：当前实例的请求成功率</p></li><li><p>Service Instance Latency：当前实例的响应延时</p></li><li><p>JVM CPU：jvm占用CPU的百分比</p></li><li><p>JVM Memory：JVM堆内存，单位MB</p></li><li><p>JVM GC Time：JVM垃圾回收时间，包含YGC和OGC</p></li><li><p>JVM GC Count：JVM垃圾回收次数，包含YGC和OGC</p></li><li><p>JVM Thread Count：JVM线程统计CLR XX：.NET服务的 指标，类似JVM虚拟机</p></li></ul><p><img src="'+_+'" alt=""></p><p>Instance：</p><ul><li><p>Endpoint Load in Current Service：每个端点的每分钟请求数</p></li><li><p>Slow Endpoints in Current Service：每个端点的最慢请求时间， 单位ms</p></li><li><p>Successful Rate in Current Service：每个端点的请求成功率</p></li><li><p>Endpoint Load：端点请求数趋势图</p></li><li><p>Endpoint Avg Response Time：端点平均响应时间趋势图</p></li><li><p>Endpoint Response Time Percentile：端口响应时间的百分位数</p></li><li><p>Endpoint Successful Rate：端点请求成功率</p></li></ul><p><img src="'+S+'" alt=""></p>',165)]))}const M=i(f,[["render",w],["__file","index.html.vue"]]),P=JSON.parse(`{"path":"/notes/k8s/0orp8ikp/","title":"微服务容器化迁移","lang":"zh-CN","frontmatter":{"title":"微服务容器化迁移","createTime":"2024/09/29 12:16:29","permalink":"/notes/k8s/0orp8ikp/","head":[["script",{"id":"check-dark-mode"},";(function () {const um= localStorage.getItem('vuepress-theme-appearance') || 'auto';const sm = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;const isDark = um === 'dark' || (um !== 'light' && sm);document.documentElement.dataset.theme = isDark ? 'dark' : 'light';})();"],["script",{"id":"check-mac-os"},"document.documentElement.classList.toggle('mac', /Mac|iPhone|iPod|iPad/i.test(navigator.platform))"]]},"headers":[{"level":2,"title":"从运维角度看微服务","slug":"从运维角度看微服务","link":"#从运维角度看微服务","children":[{"level":3,"title":"单体应用 vs 微服务","slug":"单体应用-vs-微服务","link":"#单体应用-vs-微服务","children":[]},{"level":3,"title":"微服务特点","slug":"微服务特点","link":"#微服务特点","children":[]},{"level":3,"title":"微服务不足","slug":"微服务不足","link":"#微服务不足","children":[]},{"level":3,"title":"Java微服务框架","slug":"java微服务框架","link":"#java微服务框架","children":[]}]},{"level":2,"title":"在K8s平台部署微服务考虑的问题","slug":"在k8s平台部署微服务考虑的问题","link":"#在k8s平台部署微服务考虑的问题","children":[{"level":3,"title":"常见微服务架构图","slug":"常见微服务架构图","link":"#常见微服务架构图","children":[]},{"level":3,"title":"对微服务项目架构理解","slug":"对微服务项目架构理解","link":"#对微服务项目架构理解","children":[]},{"level":3,"title":"为什么用注册中心系统","slug":"为什么用注册中心系统","link":"#为什么用注册中心系统","children":[]},{"level":3,"title":"在K8s部署项目流程","slug":"在k8s部署项目流程","link":"#在k8s部署项目流程","children":[]}]},{"level":2,"title":"在K8S平台部署Spring Cloud微服务项目","slug":"在k8s平台部署spring-cloud微服务项目","link":"#在k8s平台部署spring-cloud微服务项目","children":[{"level":3,"title":"容器化微服务项目实施步骤","slug":"容器化微服务项目实施步骤","link":"#容器化微服务项目实施步骤","children":[]},{"level":3,"title":"生产环境踩坑经验分享","slug":"生产环境踩坑经验分享","link":"#生产环境踩坑经验分享","children":[]}]},{"level":2,"title":"APM监控微服务项目","slug":"apm监控微服务项目","link":"#apm监控微服务项目","children":[{"level":3,"title":"微服务监控需求","slug":"微服务监控需求","link":"#微服务监控需求","children":[]},{"level":3,"title":"APM监控系统是什么","slug":"apm监控系统是什么","link":"#apm监控系统是什么","children":[]},{"level":3,"title":"APM监控系统选择依据","slug":"apm监控系统选择依据","link":"#apm监控系统选择依据","children":[]},{"level":3,"title":"Skywalking介绍","slug":"skywalking介绍","link":"#skywalking介绍","children":[]},{"level":3,"title":"Skywalking架构","slug":"skywalking架构","link":"#skywalking架构","children":[]},{"level":3,"title":"Skywalking部署","slug":"skywalking部署","link":"#skywalking部署","children":[]},{"level":3,"title":"微服务接入Skywalking监控","slug":"微服务接入skywalking监控","link":"#微服务接入skywalking监控","children":[]},{"level":3,"title":"Skywalking UI使用","slug":"skywalking-ui使用","link":"#skywalking-ui使用","children":[]}]}],"readingTime":{"minutes":11.21,"words":3363},"filePathRelative":"notes/k8s/upgrade/7.微服务容器化迁移.md"}`);export{M as comp,P as data};
