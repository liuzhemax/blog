import{_ as i,c as a,e as n,o as l}from"./app-D5peQ_E2.js";const e="/images/B2F7E8D287EA48A3925A323A7330F159clipboard.png",h="/images/8A7782825408485B8DA8EE01B54B7C6Fclipboard.png",k="/images/8500E07205C24CC18CCB45F93929FA11clipboard.png",p="/images/7F27157BF99A4F6B8BF5BCDE5C165B64clipboard.png",t="/images/EB9F74AB19714BC68A48BF040F27BAFAclipboard.png",d="/images/64DF0CDB13A542678BB863158428C832clipboard.png",r="/images/2306CE36027E44559E61F897D61DC8C4clipboard.png",g="/images/4F2E0C1FDB52491EB084D555FB5714DCclipboard.png",c="/images/3164AADF3CAF40CFA508FCC5C9C1495Aclipboard.png",A="/images/7A0E7C80DA0F49268AE4F87D00FE7796clipboard.png",y="/images/6922CBDC75314869BF4EC5D6B8B586CCclipboard.png",D="/images/D039E5F0FBA7457D81054CA87A761043clipboard.png",v="/images/C157478FA8444B3C8BC50AB432519AC3clipboard.png",C="/images/F8769BAA03AA41BCAF7F8A7FBE101D13clipboard.png",B="/images/41CB808D432741CEADC62C7EC31B02CFclipboard.png",u="/images/5725CE9936DC44278AB0F3D50A9C0043clipboard.png",m="/images/BBB9C34FC8074B8B8F2A8593A0D069D9clipboard.png",o="/images/1038F7245A06447F8D9087E37A05849Bclipboard.png",b="/images/8E0858A3DE2A4C5B8F819C098461D101clipboard.png",E="/images/22F701F84D6D4280B76FE0E49F0002F6clipboard.png",_="/images/2C996A5FE9374972B3F1C34D6C139C33clipboard.png",f="/images/1CB58EC278494B95B4CF18806EC80C36clipboard.png",q="/images/857EAC3742DE4C009FB7B571FB68F768clipboard.png",j={};function F(P,s){return l(),a("div",null,s[0]||(s[0]=[n('<h2 id="发布流程设计" tabindex="-1"><a class="header-anchor" href="#发布流程设计"><span>发布流程设计</span></a></h2><p><img src="'+e+`" alt=""></p><h2 id="准备基础环境-harbor、gitlab、jenkins" tabindex="-1"><a class="header-anchor" href="#准备基础环境-harbor、gitlab、jenkins"><span>准备基础环境：Harbor、Gitlab、Jenkins</span></a></h2><h3 id="harbor镜像仓库" tabindex="-1"><a class="header-anchor" href="#harbor镜像仓库"><span>Harbor镜像仓库</span></a></h3><p>项目地址：https://github.com/goharbor/harbor</p><p>1.安装docker与docker-compose</p><p>2.解压离线包部署</p><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># tar zxvf harbor-offline-installer-v2.0.0.tgz</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># cd harbor</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># cp harbor.yml.tmpl harbor.yml</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># vi harbor.yml</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">hostname:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 192.168.0.14</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">https:</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">   # 先注释https相关配置</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">harbor_admin_password:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> Harbor12345</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># ./prepare</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># ./install.sh --with-chartmuseum</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># docker-compose ps</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="3"><li>在Jenkins主机配置Docker可信任，如果是HTTPS需要拷贝证书</li></ol><p>由于habor未配置https，还需要在docker配置可信任。</p><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># cat /etc/docker/daemon.json </span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">{</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">&quot;registry-mirrors&quot;</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">:</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> [</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">https://b9pmyelo.mirror.aliyuncs.com</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">],</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  &quot;insecure-registries&quot;</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">:</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> [</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">192.168.0.12</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">]</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># systemctl restart docker</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="gitlab代码仓库" tabindex="-1"><a class="header-anchor" href="#gitlab代码仓库"><span>Gitlab代码仓库</span></a></h3><p>在Gitlab创建一个项目，然后提交微服务项目代码。</p><p>如果没有Gitlab可以使用Docker启动一个：</p><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">mkdir</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /opt/gitlab</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> </span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">GITLAB_HOME</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">/opt/gitlab</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> # 数据持久化目录</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">docker</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> run</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --detach</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \\</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">--publish </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">443:443</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \\</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">--publish </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">88:80</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \\</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">--publish </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">2222:22</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \\</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">--name </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">gitlab</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \\</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">--restart </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">always</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \\</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">--volume </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">$GITLAB_HOME</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">/config:/etc/gitlab</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \\</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">--volume </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">$GITLAB_HOME</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">/logs:/var/log/gitlab</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \\</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">--volume </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">$GITLAB_HOME</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">/data:/var/opt/gitlab</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \\</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">gitlab/gitlab-ce:latest</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>访问地址：http://IP:88</p><p>初次会先设置管理员密码 ，然后登陆，默认管理员用户名 root，密码就是刚设置的。</p><p><img src="`+h+'" alt=""></p><h3 id="jenkins-发布系统" tabindex="-1"><a class="header-anchor" href="#jenkins-发布系统"><span>Jenkins 发布系统</span></a></h3><p><img src="'+k+`" alt=""></p><p>Jenkins是一款开源 CI&amp;CD 系统，用于自动化各种任务，包括构建、测试和部署。</p><p>Jenkins官方提供了镜像：https://hub.docker.com/r/jenkins/jenkins</p><p>使用Deployment来部署这个镜像，会暴露两个端口：8080 Web访问端口，50000 Slave通 信端口，容器启动后Jenkins数据存储在/var/jenkins_home目录，所以需要将该目录使用 PV持久化存储。</p><p>配置PV持久化存储：</p><p>1、部署NFS共享服务器</p><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#安装nfs安装包（每个k8s节点都要安装）</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">yum</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> install</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> nfs-utils</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>2、找一个节点作为NFS共享存储服务器</p><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#创建nfs共享目录</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">mkdir</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -p</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /ifs/kubernetes/jenkins-data</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#修改nfs配置文件</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">vim</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/exports</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">/ifs/kubernetes</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 192.168.0.0/24</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">rw,no_root_squash</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#启动nfs并加入开机自启</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">systemctl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> start</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> nfs</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">systemctl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> enable</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> nfs</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#在别的节点验证是否能挂载成功</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">mount</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -t</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> nfs</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 192.168.0.13:/ifs/kubernetes</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /mnt/</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">umount</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /mnt/</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>3、为Jenkins准备PV</p><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#vi pv.yaml</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">apiVersion:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> v1</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kind:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> PersistentVolume</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">metadata:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  name:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> pv0001</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">spec:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  capacity:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    storage:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 5Gi</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  accessModes:</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> [</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">ReadWriteOnce</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">]</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  nfs:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    path:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /ifs/kubernetes/jenkins-data</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    server:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 192.168.0.13</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#kubectl apply -f pv.yaml</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在k8s中部署jenkins</p><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> apply</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -f</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> jenkins.yml</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>先安装后面所需的插件：</p><p>Jenkins下载插件默认服务器在国外，会比较慢，建议修改国内源：</p><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> # 进入到nfs共享目录</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">cd</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /ifs/kubernetes/jenkins-data</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">sed</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -i</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">s/https:\\/\\/updates.jenkins.io\\/download/https:\\/\\/mirrors.tuna.tsinghua.edu.cn\\/jenkins/g</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> default.json</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> </span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">sed</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -i</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">s/http:\\/\\/www.google.com/https:\\/\\/www.baidu.com/g</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> default.json</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 删除pod重建，pod名称改成你实际的</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> delete</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> pod</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> jenkins-d58f4db66-9cthj</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -n</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ops</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>管理Jenkins-&gt;系统配置--&gt;管理插件--&gt;分别搜索Git Parameter/Git/Pipeline/kubernetes/Config File Provider， 选中点击安装。</p><ul><li><p>Git：拉取代码</p></li><li><p>Git Parameter：Git参数化构建</p></li><li><p>Pipeline：流水线</p></li><li><p>kubernetes：连接Kubernetes动态创建Slave代理</p></li><li><p>Config File Provider：存储配置文件</p></li><li><p>Extended Choice Parameter：扩展选择框参数，支持多选</p></li></ul><h2 id="jenkins在k8s中动态创建代理" tabindex="-1"><a class="header-anchor" href="#jenkins在k8s中动态创建代理"><span>Jenkins在K8s中动态创建代理</span></a></h2><h3 id="jenkins主从架构介绍" tabindex="-1"><a class="header-anchor" href="#jenkins主从架构介绍"><span>Jenkins主从架构介绍</span></a></h3><p><img src="`+p+'" alt=""></p><p>Jenkins Master/Slave架构，Master（Jenkins本身）提供Web页面 让用户来管理项目和从节点（Slave），项目任务可以运行在Master 本机或者分配到从节点运行，一个Master可以关联多个Slave，这样 好处是可以让Slave分担Master工作压力和隔离构建环境。</p><p><img src="'+t+'" alt=""></p><p>当触发Jenkins任务时，Jenkins会调用Kubernetes API 创建Slave Pod，Pod启动后会连接Jenkins，接受任务 并处理。</p><h3 id="kubernetes插件配置" tabindex="-1"><a class="header-anchor" href="#kubernetes插件配置"><span>Kubernetes插件配置</span></a></h3><p>Kubernetes插件：用于Jenkins在Kubernetes集群中运行动态代理</p><p>插件介绍：https://github.com/jenkinsci/kubernetes-plugin</p><p>配置插件：管理Jenkins-&gt;管理Nodes和云-&gt;管理云-&gt;添加Kubernetes</p><p><img src="'+d+'" alt=""></p><h3 id="自定义jenkins-slave镜像" tabindex="-1"><a class="header-anchor" href="#自定义jenkins-slave镜像"><span>自定义Jenkins Slave镜像</span></a></h3><p><img src="'+r+`" alt=""></p><p><a href="/attachments/2F46856C2A2540D8A87DCF2C081ADF24jenkins-slave.zip">jenkins-slave.zip</a></p><p>构建salve镜像</p><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">unzip</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> jenkins-slave.zip</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> </span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">cd</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> jenkins-slave/</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>课件目录里涉及六个文件：</p><ul><li><p>Dockerfile：构建镜像</p></li><li><p>jenkins-slave：shell脚本启动slave.jar，下载地址：https://github.com/jenkinsci/docker-jnlpslave/blob/master/jenkins-slave</p></li><li><p>settings.xml：修改maven官方源为阿里云源</p></li><li><p>slave.jar：agent程序，接受master下发的任务，下载地址:http://jenkinsip:port/jnlpJars/slave.jar</p></li><li><p>helm和kubectl客户端工具</p></li></ul><p>构建并推送到镜像仓库：</p><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">docker</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> build</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -t</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 192.168.0.14/library/jenkins-slave-jdk:1.8</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> .</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">docker</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> push</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 192.168.0.14/library/jenkins-slave-jdk:1.8</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="`+g+'" alt=""></p><h3 id="测试主从架构是否正常" tabindex="-1"><a class="header-anchor" href="#测试主从架构是否正常"><span>测试主从架构是否正常</span></a></h3><p>新建项目-&gt;流水线-&gt;Pipeline脚本（可生成示例）</p><p><img src="'+c+`" alt=""></p><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">pipeline</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    agent</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        kubernetes</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">            label</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">jenkins-slave</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">            yaml</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;&#39;&#39;</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">apiVersion: v1</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">kind: Pod</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">metadata:</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  name: jenkins-slave</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">spec:</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  containers:</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  - name: jnlp</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    image: &quot;192.168.0.14/library/jenkins-slave-jdk:1.8&quot;</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;&#39;&#39;</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">        }</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    }</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    stages</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        stage(</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">&#39;Main&#39;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">) </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">{</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">            steps</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">                sh</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">hostname</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">            }</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">        }</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    }</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="jenkins-pipeline流水线" tabindex="-1"><a class="header-anchor" href="#jenkins-pipeline流水线"><span>Jenkins Pipeline流水线</span></a></h2><h3 id="jenkins-pipeline-介绍" tabindex="-1"><a class="header-anchor" href="#jenkins-pipeline-介绍"><span>Jenkins Pipeline 介绍</span></a></h3><p>Jenkins Pipeline是一套运行工作流框架，将原本独立运行单个或者多个节点的任 务链接起来，实现单个任务难以完成的复杂流程编排和可视化。</p><ul><li><p>Jenkins Pipeline是一套插件，支持在Jenkins中实现持续集成和持续交付；</p></li><li><p>Pipeline通过特定语法对简单到复杂的传输管道进行建模；</p></li><li><p>Jenkins Pipeline的定义被写入一个文本文件，称为Jenkinsfile。</p></li></ul><p><img src="`+A+'" alt=""></p><h3 id="jenkins-pipeline-语法" tabindex="-1"><a class="header-anchor" href="#jenkins-pipeline-语法"><span>Jenkins Pipeline 语法</span></a></h3><p><img src="'+y+'" alt=""></p><h3 id="jenkins-pipeline-示例" tabindex="-1"><a class="header-anchor" href="#jenkins-pipeline-示例"><span>Jenkins Pipeline 示例</span></a></h3><ul><li><p>Stages 是 Pipeline 中最主要的组成部分，Jenkins 将会按照 Stages 中描述的顺序 从上往下的执行。</p></li><li><p>Stage：阶段，一个 Pipeline 可以划分为若干个 Stage，每个 Stage 代表一组操作， 比如：Build、Test、Deploy</p></li><li><p>Steps：步骤，Steps 是最基本的操作单元，可以是打印一句话，也可以是构建一 个 Docker 镜像，由各类 Jenkins 插件提供，比如命令：sh ‘mvn&#39;，就相当于我 们平时 shell 终端中执行 mvn命令一样。</p></li></ul><p><img src="'+D+'" alt=""></p><h2 id="流水线自动发布微服务项目" tabindex="-1"><a class="header-anchor" href="#流水线自动发布微服务项目"><span>流水线自动发布微服务项目</span></a></h2><h3 id="发布需求" tabindex="-1"><a class="header-anchor" href="#发布需求"><span>发布需求</span></a></h3><p>在将微服务项目自动化部署到K8s平台会有这些需求：</p><ul><li><p>尽量完全自动化部署，无需过多人工干预</p></li><li><p>可以选择升级某个、某些微服务</p></li><li><p>在部署、升级微服务时，可对微服务某些特性做配置，例如命名 空间、副本数量</p></li></ul><p><img src="'+v+'" alt=""></p><p><img src="'+C+'" alt=""></p><h3 id="实现思路" tabindex="-1"><a class="header-anchor" href="#实现思路"><span>实现思路</span></a></h3><p>Pipeline编写思路：</p><p>在微服务架构中，会涉及几个、几十个微服务，如果每个服务都创建一个item，势必 给运维维护成本增加很大，因此需要编写一个通用Pipeline脚本，将这些微服务部署 差异化部分使用Jenkins参数化，人工交互确认发布的微服务、环境配置等。 但这只是解决用户交互层面，在K8s实际部署项目用YAML创建对应资源，现在问题是 如何接收用户交互参数，自动化生成YAML文件，这就会用到Helm完成YAML文件高 效复用和微服务部署。</p><p>部署一个微服务项目，每个微服务的差异化部分在哪里？</p><ul><li><p>服务名称</p></li><li><p>代码版本</p></li><li><p>镜像</p></li><li><p>端口</p></li><li><p>副本数</p></li><li><p>标签</p></li><li><p>域名</p></li></ul><p><img src="'+B+'" alt=""></p><p><img src="'+u+'" alt=""></p><h3 id="编写pipeline流水线脚本" tabindex="-1"><a class="header-anchor" href="#编写pipeline流水线脚本"><span>编写Pipeline流水线脚本</span></a></h3><p>对于课件中的Pipeline脚本，重点修改这几个变量：</p><p><img src="'+m+'" alt=""></p><p>1、将harbor认证和gitlab认证保存到Jenkins凭据</p><p>管理Jenkins-&gt;安全--&gt;管理凭据-&gt;Jnekins-&gt;添加凭据-&gt;Username with password</p><p>分别添加连接gitlab和harbor的用户名到Jenkins凭据，然后获取该凭据ID替换到脚本中docker_registry_auth和git_auth变量的值。</p><p><img src="'+o+'" alt=""></p><p>2、将kubeconfig存储在Jenkins，用于slave镜像里kubectl连接k8s集群</p><p>管理Jenkins-&gt; Managed files-&gt;Add-&gt;Custom file -&gt;Content字段内容是kubeconfig（kubeadm部署k8s默认路径在master节点 /root/.kube/config，如果你是二进制部署，需要自己生成，参考下面），然后复制ID替换上述脚本中k8s_auth变量的值。</p><p>说明：将kubectl、helm工具封装到Slave镜像中，并通过Config File Provider插件存储连接K8s集群的kubeconfig认证文件，然后挂载到 Slave容器中，这样就能用kubectl apply deploy.yaml --kubeconfig=config管理K8s应用了，为提高安全性，kubeconfig文件可分配权限。</p><p><img src="'+b+'" alt=""></p><p>3.上传 helm chart包到镜像仓库</p><p><a href="/attachments/0D60374F19514E8F9EE6A7B512555D72ms-0.1.0.tgz">ms-0.1.0.tgz</a></p><p><img src="'+E+`" alt=""></p><p>创建命名空间并部署eureka和MySQL服务（记得还要部署ingress控制器）</p><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> create</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> namespace</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ms</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> apply</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -f</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> mysql.yaml</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#启动部署(修改eureka-service微服务yaml文件中的requests，请求资源设置小一点0.2)</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">./docker_build.sh</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> eureka-service</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> apply</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -f</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ingress-controller.yaml</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>jenkinsfile</p><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#!/usr/bin/env groovy</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">//</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 所需插件:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> Git</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> Parameter/Git/Pipeline/Config</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> File</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> Provider/kubernetes/Extended</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> Choice</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> Parameter</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">//</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 公共</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">def</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> registry</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> =</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">192.168.0.14</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">//</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 项目</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">def</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> operation</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> =</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">microservice</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">def</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> git_url</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> =</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">http://192.168.0.14:88/root/k8s-microservice.git</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">def</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> gateway_domain_name</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> =</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">gateway.ctnrs.com</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">def</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> portal_domain_name</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> =</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">portal.ctnrs.com</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">//</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 认证</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">def</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> image_pull_secret</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> =</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">registry-pull-secret</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">def</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> harbor_auth</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> =</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">dc8877f5-3238-407f-a9fb-96932501a9b0</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">def</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> git_auth</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> =</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">8d022667-0d69-4e5c-a6f8-6d0ac532f596</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">//</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ConfigFileProvider</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ID</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">def</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> k8s_auth</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> =</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">cf3c93bc-dc97-4305-8379-53a669a2b2b7</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">pipeline</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  agent</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    kubernetes</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        label</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">jenkins-slave</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        yaml</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;&quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">apiVersion: v1</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">kind: Pod</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">metadata:</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  name: jenkins-slave</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">spec:</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  containers:</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  - name: jnlp</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    image: </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">\${</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">registry</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">/library/jenkins-slave-jdk:1.8</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    imagePullPolicy: Always</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    volumeMounts:</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      - name: docker-cmd</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        mountPath: /usr/bin/docker</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      - name: docker-sock</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        mountPath: /var/run/docker.sock</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      - name: maven-cache</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        mountPath: /root/.m2</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  volumes:</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    - name: docker-cmd</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      hostPath:</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        path: /usr/bin/docker</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    - name: docker-sock</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      hostPath:</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        path: /var/run/docker.sock</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    - name: maven-cache</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      hostPath:</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        path: /tmp/m2</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;&quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">        }</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">      </span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">      }</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    parameters</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        gitParameter</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> branch:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">,</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> branchFilter:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">.*</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">,</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> defaultValue:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">origin/master</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">,</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> description:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">选择发布的分支</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">,</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> name:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Branch</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">,</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> quickFilterEnabled:</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> false</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">,</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> selectedValue:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">NONE</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">,</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> sortMode:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">NONE</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">,</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> tagFilter:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">*</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">,</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> type:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">PT_BRANCH</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">        </span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        extendedChoice</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> defaultValue:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">none</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">,</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> description:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">选择发布的微服务</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">,</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">          multiSelectDelimiter:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">,</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">,</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> name:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Service</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">,</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> type:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">PT_CHECKBOX</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">,</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">          value:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">gateway-service:9999,portal-service:8080,product-service:8010,order-service:8020,stock-service:8030</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        choice</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> (choices: [</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">ms</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">demo</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">],</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> description:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">部署模板</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">,</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> name:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Template</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">)</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        choice</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> (choices: [</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">1</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">3</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">,</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">5</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">,</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">7</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">],</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> description:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">副本数</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">,</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> name:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">ReplicaCount</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">)</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        choice</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> (choices: [</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">ms</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">], description: </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">命名空间</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, name: </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Namespace</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">)</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    }</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    stages</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        stage(</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">&#39;拉取代码&#39;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">){</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">            steps</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">                checkout([$class:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">GitSCM</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">,</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> </span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">                branches:</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> [[name: </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">\${</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">params.Branch</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">]],</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> </span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">                extensions:</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> [], </span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">                userRemoteConfigs:</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> [[credentialsId: </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">\${</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">git_auth</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">,</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> url:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">\${</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">git_url</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">]]</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">                ])</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">            }</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">        }</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        stage(</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">&#39;代码编译&#39;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">) </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">{</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">            //</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 编译指定服务</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">            steps</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">                sh</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;&quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                  mvn clean package -Dmaven.test.skip=true</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">                &quot;&quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">            }</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">        }</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        stage(</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">&#39;构建镜像&#39;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">) </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">{</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">          steps</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">              withCredentials([usernamePassword(credentialsId:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">\${</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">harbor_auth</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">,</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> passwordVariable:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">password</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">,</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> usernameVariable:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">username</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">)]) </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">{</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">                sh</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;&quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                 docker login -u </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">\${</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">username</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> -p &#39;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">\${</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">password</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">&#39; </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">\${</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">registry</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                 for service in </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\$</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">(echo </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">\${</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Service</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> |sed &#39;s/,/ /g&#39;); do</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                    service_name=</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\$</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">{service%:*}</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                    image_name=</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">\${</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">registry</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">/</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">\${</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">operation</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">/</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\$</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">{service_name}:</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">\${</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">BUILD_NUMBER</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                    cd </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\$</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">{service_name}</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                    if ls |grep biz &amp;&gt;/dev/null; then</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                        cd </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\$</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">{service_name}-biz</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                    fi</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                    docker build -t </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\$</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">{image_name} .</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                    docker push </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\$</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">{image_name}</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                    cd </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">\${</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">WORKSPACE</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                  done</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">                &quot;&quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">                configFileProvider([configFile(fileId:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">\${</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">k8s_auth</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">,</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> targetLocation:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">admin.kubeconfig</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">)]){</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">                    sh</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;&quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                    # 添加镜像拉取认证</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                    kubectl create secret docker-registry </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">\${</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">image_pull_secret</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> --docker-username=</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">\${</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">username</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> --docker-password=</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">\${</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">password</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> --docker-server=</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">\${</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">registry</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> -n </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">\${</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Namespace</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> --kubeconfig admin.kubeconfig |true</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                    # 添加私有chart仓库</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                    helm repo add  --username </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">\${</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">username</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> --password </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">\${</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">password</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> myrepo http://</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">\${</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">registry</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">/chartrepo/</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">\${</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">operation</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">                    &quot;&quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">                }</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">              }</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">          }</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">        }</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        stage(</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">&#39;Helm部署到K8S&#39;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">) </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">{</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">          steps</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">              sh</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;&quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">              common_args=</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">-n</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> \${</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">Namespace</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --kubeconfig</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> admin.kubeconfig</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">              </span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">              for service in  </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\$</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">(echo </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">\${</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Service</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> |sed &#39;s/,/ /g&#39;); do</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                service_name=</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\$</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">{service%:*}</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                service_port=</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\$</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">{service#*:}</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                image=</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">\${</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">registry</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">/</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">\${</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">operation</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">/</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\$</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">{service_name}</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                tag=</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">\${</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">BUILD_NUMBER</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                helm_args=</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\$</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">{service_name}</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --set</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> image.repository=</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\$</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">{image}</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --set</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> image.tag=</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\$</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">{tag}</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --set</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> replicaCount=</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">\${</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">replicaCount</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --set</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> imagePullSecrets[0].name=</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">\${</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">image_pull_secret</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --set</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> service.targetPort=</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\$</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">{service_port}</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> myrepo/</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">\${</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">Template</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                # 判断是否为新部署</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                if helm history </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\$</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">{service_name} </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\$</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">{common_args} &amp;&gt;/dev/null;then</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                  action=upgrade</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                else</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                  action=install</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                fi</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                # 针对服务启用ingress</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                if [ </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\$</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">{service_name} == </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">gateway-service</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ]; then</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                  helm </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\$</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">{action} </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\$</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">{helm_args} </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                  --set ingress.enabled=true </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                  --set ingress.host=</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">\${</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">gateway_domain_name</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \\</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">                   \\$</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">{common_args}</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                elif [ </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\$</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">{service_name} == </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">portal-service</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ]; then</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                  helm </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\$</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">{action} </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\$</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">{helm_args} </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                  --set ingress.enabled=true </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                  --set ingress.host=</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">\${</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">portal_domain_name</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \\</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">                   \\$</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">{common_args}</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                else</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                  helm </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\$</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">{action} </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\$</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">{helm_args} </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\$</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">{common_args}</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                fi</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">              done</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">              # 查看Pod状态</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">              sleep 10</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">              kubectl get pods </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\$</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">{common_args}</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">              &quot;&quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">          }</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">        }</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    }</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>最终效果图：</p><p><img src="`+_+'" alt=""></p><h3 id="流水线脚本与源代码一起版本管理" tabindex="-1"><a class="header-anchor" href="#流水线脚本与源代码一起版本管理"><span>流水线脚本与源代码一起版本管理</span></a></h3><p>Jenkinsfile文件建议与源代码一起版本管理，实现流水线即 代码（Pipeline as Code）。</p><p>这样做的好处：</p><ul><li><p>自动为所有分支创建流水线脚本</p></li><li><p>方便流水线代码复查、追踪、迭代</p></li><li><p>可被项目成员查看和编辑</p></li></ul><p><img src="'+f+'" alt=""></p><p><img src="'+q+'" alt=""></p><h2 id="小结" tabindex="-1"><a class="header-anchor" href="#小结"><span>小结</span></a></h2><p>使用Jenkins的插件</p><ul><li><p>Git &amp; gitParameter</p></li><li><p>Kubernetes</p></li><li><p>Pipeline</p></li><li><p>Config File Provider</p></li><li><p>Extended Choice Parameter</p></li></ul><p>CI/CD环境特点</p><ul><li><p>Slave弹性伸缩</p></li><li><p>基于镜像隔离构建环境</p></li><li><p>流水线发布，易维护</p></li></ul><p>Jenkins参数化构建可帮助你完成更复杂环境CI/CD</p><p>回滚思路：</p><p>1.使用kubectl rollout ,将资源名称和命名空间等参数化传入</p><p>2.每次发布记录发布的镜像版本写到一个历史文件中，Extended choice Parameter从历史文件中作为选择项</p>',120)]))}const J=i(j,[["render",F],["__file","index.html.vue"]]),x=JSON.parse(`{"path":"/notes/k8s/chfe0n1x/","title":"基于jenkins构建微服务发布平台","lang":"zh-CN","frontmatter":{"title":"基于jenkins构建微服务发布平台","createTime":"2024/09/29 12:16:55","permalink":"/notes/k8s/chfe0n1x/","head":[["script",{"id":"check-dark-mode"},";(function () {const um= localStorage.getItem('vuepress-theme-appearance') || 'auto';const sm = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;const isDark = um === 'dark' || (um !== 'light' && sm);document.documentElement.dataset.theme = isDark ? 'dark' : 'light';})();"],["script",{"id":"check-mac-os"},"document.documentElement.classList.toggle('mac', /Mac|iPhone|iPod|iPad/i.test(navigator.platform))"]]},"headers":[{"level":2,"title":"发布流程设计","slug":"发布流程设计","link":"#发布流程设计","children":[]},{"level":2,"title":"准备基础环境：Harbor、Gitlab、Jenkins","slug":"准备基础环境-harbor、gitlab、jenkins","link":"#准备基础环境-harbor、gitlab、jenkins","children":[{"level":3,"title":"Harbor镜像仓库","slug":"harbor镜像仓库","link":"#harbor镜像仓库","children":[]},{"level":3,"title":"Gitlab代码仓库","slug":"gitlab代码仓库","link":"#gitlab代码仓库","children":[]},{"level":3,"title":"Jenkins 发布系统","slug":"jenkins-发布系统","link":"#jenkins-发布系统","children":[]}]},{"level":2,"title":"Jenkins在K8s中动态创建代理","slug":"jenkins在k8s中动态创建代理","link":"#jenkins在k8s中动态创建代理","children":[{"level":3,"title":"Jenkins主从架构介绍","slug":"jenkins主从架构介绍","link":"#jenkins主从架构介绍","children":[]},{"level":3,"title":"Kubernetes插件配置","slug":"kubernetes插件配置","link":"#kubernetes插件配置","children":[]},{"level":3,"title":"自定义Jenkins Slave镜像","slug":"自定义jenkins-slave镜像","link":"#自定义jenkins-slave镜像","children":[]},{"level":3,"title":"测试主从架构是否正常","slug":"测试主从架构是否正常","link":"#测试主从架构是否正常","children":[]}]},{"level":2,"title":"Jenkins Pipeline流水线","slug":"jenkins-pipeline流水线","link":"#jenkins-pipeline流水线","children":[{"level":3,"title":"Jenkins Pipeline 介绍","slug":"jenkins-pipeline-介绍","link":"#jenkins-pipeline-介绍","children":[]},{"level":3,"title":"Jenkins Pipeline 语法","slug":"jenkins-pipeline-语法","link":"#jenkins-pipeline-语法","children":[]},{"level":3,"title":"Jenkins Pipeline 示例","slug":"jenkins-pipeline-示例","link":"#jenkins-pipeline-示例","children":[]}]},{"level":2,"title":"流水线自动发布微服务项目","slug":"流水线自动发布微服务项目","link":"#流水线自动发布微服务项目","children":[{"level":3,"title":"发布需求","slug":"发布需求","link":"#发布需求","children":[]},{"level":3,"title":"实现思路","slug":"实现思路","link":"#实现思路","children":[]},{"level":3,"title":"编写Pipeline流水线脚本","slug":"编写pipeline流水线脚本","link":"#编写pipeline流水线脚本","children":[]},{"level":3,"title":"流水线脚本与源代码一起版本管理","slug":"流水线脚本与源代码一起版本管理","link":"#流水线脚本与源代码一起版本管理","children":[]}]},{"level":2,"title":"小结","slug":"小结","link":"#小结","children":[]}],"readingTime":{"minutes":9,"words":2700},"filePathRelative":"notes/k8s/upgrade/8.基于jenkins构建微服务发布平台.md"}`);export{J as comp,x as data};
