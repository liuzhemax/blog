import{_ as a,c as e,e as i,a as n,o as l}from"./app-D5peQ_E2.js";const p="/images/02E7559039504D2697674993D5445F38clipboard.png",t="/images/2D613AC47FB64D1E9B2A92FF54B9EE98clipboard.png",h="/images/810B7F4A81EE44BA9DD094BF855C8763clipboard.png",r="/images/94A58E9E493A4507828805F430835074clipboard.png",k="/images/E0C7336FB9014DCF886C68EA1A6D4BDAclipboard.png",d="/images/C15669D7F54143B9B450796E42803460clipboard.png",c="/images/27D0E1AC0E504AF28615CE9BA0D66E7Aclipboard.png",o="/images/AFBC9203DEBA40ECBFE01B98E1F76880clipboard.png",A="/images/7A103C798FC745D78E01C269EA892CEEclipboard.png",u="/images/80903A4C542A4376BF2CCF2255CA6F5Fclipboard.png",m="/images/166CD46A4C7F4434A1E761175A1B05E6clipboard.png",g="/images/29359740BD3A4AF498A5A7CC1F94E911clipboard.png",v="/images/49E932B96C6241CABC2D385839708FE4clipboard.png",y={};function b(D,s){return l(),e("div",null,s[0]||(s[0]=[i('<h2 id="prometheus-介绍" tabindex="-1"><a class="header-anchor" href="#prometheus-介绍"><span>Prometheus 介绍</span></a></h2><p>Prometheus（普罗米修斯）是一个最初在SoundCloud上构建的监控系统。自2012年成为社区开源项目， 拥有非常活跃的开发人员和用户社区。为强调开源及独立维护，Prometheus于2016年加入云原生云计算基 金会（CNCF），成为继Kubernetes之后的第二个托管项目。</p><p>https://prometheus.io/</p><p>https://github.com/prometheus</p><h2 id="prometheus组件与架构" tabindex="-1"><a class="header-anchor" href="#prometheus组件与架构"><span>Prometheus组件与架构</span></a></h2><p><img src="'+p+'" alt=""></p><ul><li><p>Prometheus Server：收集指标和存储时间序列数据，并提供查询接口</p></li><li><p>ClientLibrary：客户端库</p></li><li><p>Push Gateway：短期存储指标数据。主要用于临时性的任务</p></li><li><p>Exporters：采集已有的第三方服务监控指标并暴露metrics</p></li><li><p>Alertmanager：告警</p></li><li><p>Web UI：简单的Web控制台</p></li></ul><h2 id="prometheus基本使用-怎么来监控" tabindex="-1"><a class="header-anchor" href="#prometheus基本使用-怎么来监控"><span>Prometheus基本使用：怎么来监控？</span></a></h2><p>如果要想监控，前提是能获取被监控端指标数据，并且这个 数据格式必须遵循Prometheus数据模型，这样才能识别和 采集，一般使用exporter提供监控指标数据</p><p>exporter列表：</p><p>https://prometheus.io/docs/instrumenting/exporters</p><p><img src="'+t+'" alt=""></p><ul><li><p>Prometheus Server：收集指标和存储时间序列数据，并提供查询接口</p></li><li><p>ClientLibrary：客户端库</p></li><li><p>Push Gateway：短期存储指标数据。主要用于临时性的任务</p></li><li><p>Exporters：采集已有的第三方服务监控指标并暴露metrics</p></li><li><p>Alertmanager：告警</p></li><li><p>Web UI：简单的Web控制台</p></li></ul><h2 id="prometheus基本使用-部署" tabindex="-1"><a class="header-anchor" href="#prometheus基本使用-部署"><span>Prometheus基本使用：部署</span></a></h2><p>部署Prometheus：</p><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">docker</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> run</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -d</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --name=prometheus</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -p</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 9090:9090</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> prom/prometheus</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>访问地址：http://ip:9090/</p><p>部署文档：https://prometheus.io/docs/prometheus/latest/installation/</p><p>部署Grafana：</p><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">docker</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> run</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -d</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --name=grafana</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -p</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 3000:3000</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> grafana/grafana</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>访问地址：http://ip:3000/</p><p>部署文档：https://grafana.com/grafana/download</p><p>用户名/密码：admin/admin # 第一次需要重置密码</p><p><img src="'+h+`" alt=""></p><h2 id="prometheus基本使用-监控linux服务器" tabindex="-1"><a class="header-anchor" href="#prometheus基本使用-监控linux服务器"><span>Prometheus基本使用：监控Linux服务器</span></a></h2><p>node_exporter：用于监控Linux系统的指标采集器。</p><p>常用指标：</p><ul><li><p>CPU</p></li><li><p>内存</p></li><li><p>硬盘</p></li><li><p>网络流量</p></li><li><p>文件描述符</p></li><li><p>系统负载</p></li><li><p>系统服务</p></li></ul><p>数据接口：http://ip:9100/</p><p>使用文档：https://prometheus.io/docs/guides/node-exporter/</p><p>GitHub：https://github.com/prometheus/node_exporter</p><p>在Prometheus配置文件添加被监控端：</p><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">scrape_configs:</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">                                                    </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">  # The job name is added as a label \`job=&lt;job_name&gt;\` to any timeseries scraped from this config.</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  -</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> job_name:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">prometheus</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">                                                                       </span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">                                                                                                 </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    # metrics_path defaults to &#39;/metrics&#39;</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    # scheme defaults to &#39;http&#39;.         </span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">                                         </span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    static_configs:</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">             </span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    -</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> targets:</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> [</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">localhost:9090</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">]</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  -</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> job_name:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Linux Server</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">     </span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    static_configs:</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">              </span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    -</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> targets:</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> [</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">192.168.0.12:9100</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">,</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">192.168.0.13:9100</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">]</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>使用Grafana展示node_exporter数据指标，仪表盘ID： 9276</p><p><img src="`+r+'" alt=""></p><p><img src="'+k+'" alt=""></p><h2 id="prometheus基本使用-查询数据" tabindex="-1"><a class="header-anchor" href="#prometheus基本使用-查询数据"><span>Prometheus基本使用：查询数据</span></a></h2><p>PromQL(Prometheus Query Language) 是 Prometheus 自己开发的数据查询 DSL 语言，语言表现力非常丰 富，支持条件查询、操作符，并且内建了大量内置函数，供我们针对监控数据的各种维度进行查询。</p><p>数据模型：</p><ul><li><p>Prometheus将所有数据存储为时间序列；</p></li><li><p>具有相同度量名称以及标签属于同一个指标；</p></li><li><p>每个时间序列都由度量标准名称和一组键值对（称为标签）唯一标识， 通过标签查询指定指标。</p></li></ul><p>指标格式：</p><div class="language- line-numbers-mode" data-ext="" data-title=""><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span>&lt;metric name&gt;{&lt;label name&gt;=&lt;label value&gt;,...}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>示例：</p><p>查询指标最新样本（称为瞬时向量）：</p><p>node_cpu_seconds_total</p><p>可以通过附加一组标签来进一步过来这些时间序列：</p>',46),n("p",{job:"Linux Server"},"node_cpu_seconds_total",-1),i('<p>查询指标近5分钟内样本（称为范围向量，时间单位 s，m，h，d，w，y）： node_cpu_seconds_total{job=&quot;Linux Server&quot;}[5m]</p><p>node_cpu_seconds_total{job=&quot;Linux Server&quot;}[1h]</p><p><img src="'+d+'" alt=""></p><h2 id="kubernetes-监控指标" tabindex="-1"><a class="header-anchor" href="#kubernetes-监控指标"><span>Kubernetes 监控指标</span></a></h2><p>Kubernetes本身监控</p><ul><li><p>Node资源利用率</p></li><li><p>Node数量</p></li><li><p>每个Node运行Pod数量</p></li><li><p>资源对象状态</p></li></ul><p>Pod监控</p><ul><li><p>Pod总数量及每个控制器预期数量</p></li><li><p>Pod状态</p></li><li><p>容器资源利用率：CPU、内存、网络</p></li></ul><h2 id="kubernetes-监控实现思路" tabindex="-1"><a class="header-anchor" href="#kubernetes-监控实现思路"><span>Kubernetes 监控实现思路</span></a></h2><p><img src="'+c+'" alt=""></p><p><img src="'+o+`" alt=""></p><p>Pod</p><p>kubelet的节点使用cAdvisor提供的metrics接口获取该节点所有Pod和容器相关的性能指标数据。</p><p>指标接口：https://NodeIP:10250/metrics/cadvisor</p><p>Node</p><p>使用node_exporter收集器采集节点资源利用率。</p><p>项目地址：https://github.com/prometheus/node_exporter</p><p>K8s资源对象</p><p>kube-state-metrics采集了k8s中各种资源对象的状态信息。</p><p>项目地址：https://github.com/kubernetes/kube-state-metrics</p><h2 id="在kubernetes平台部署相关组件" tabindex="-1"><a class="header-anchor" href="#在kubernetes平台部署相关组件"><span>在Kubernetes平台部署相关组件</span></a></h2><p><a href="/attachments/40AFBBBACCBA4802B365208376B77297prometheus.zip">prometheus.zip</a></p><ul><li><p>prometheus-deployment.yaml # 部署Prometheus</p></li><li><p>prometheus-configmap.yaml # Prometheus配置文件，主要配置Kubernetes服务发现</p></li><li><p>prometheus-rules.yaml # Prometheus告警规则</p></li><li><p>grafana.yaml # 可视化展示</p></li><li><p>node-exporter.yml # 采集节点资源，通过DaemonSet方式部署，并声明让Prometheus收集</p></li><li><p>kube-state-metrics.yaml # 采集K8s资源，并声明让Prometheus收集</p></li><li><p>alertmanager-configmap.yaml # 配置文件，配置发件人和收件人</p></li><li><p>alertmanager-deployment.yaml # 部署Alertmanager告警组件</p></li></ul><p><a href="/attachments/3FC447C7D2D84D568FEA2B0B3AD166C7nfs-client.zip">nfs-client.zip</a></p><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#安装nfs安装包（每个k8s节点都要安装）</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">yum</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> install</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> nfs-utils</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#创建nfs共享目录</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">mkdir</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -p</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /nfs/kubernetes</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#修改nfs配置文件</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">vim</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/exports</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">/nfs/kubernetes</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> *</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">rw,no_root_squash</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#启动nfs并加入开机自启</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">systemctl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> start</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> nfs</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">systemctl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> enable</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> nfs</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#部署NFS实现自动创建PV插件：</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">git</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> clone</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> https://github.com/kubernetes-incubator/external-storage</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> </span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">cd</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> nfs-client/deploy</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> </span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> apply</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -f</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> rbac.yaml</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> # 授权访问apiserver </span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> apply</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -f</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> deployment.yaml</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> # 部署插件，需修改里面NFS服务器地址与共享目录 </span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> apply</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -f</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> class.yaml</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> # 创建存储类</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> get</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> sc</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">  # 查看存储类</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubernetes-node-kubelet:获取kebelet暴露的指标，访问地址https://NodeIP:10250/metrics</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubernetes-node-cadvisor:获取kubelet暴露的cadvisor，访问地址https://NodeIP:10250/metrics/cadvisor</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubernetes-service-endpooints:从service列表只能endpoint发现pod为目标</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubernetes-pod:发现所有pod为目标</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">给pod重新标记标签</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">1.配置采集pod的默认采集信息，例如协议，端口，url</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">2.给pod添加标签，方便后面对数据多维度查询</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#prometheus和altermanger手动热加载配置</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">curl</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -XPOST</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 10.244.169.152:9093/-/reload</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="prometheus-告警" tabindex="-1"><a class="header-anchor" href="#prometheus-告警"><span>Prometheus 告警</span></a></h2><p>Prometheus报警功能利用Alertmanager组件完成，当Prometheus会对接收的指标数据比对告警规则，如果 满足条件，则将告警事件发送给Alertmanager组件，Alertmanager组件发送到接收人。</p><p>使用步骤：</p><ol><li><p>部署Alertmanager</p></li><li><p>配置告警接收人</p></li><li><p>配置Prometheus与Alertmanager通信</p></li><li><p>在Prometheus中创建告警规则</p></li></ol><p><img src="`+A+`" alt=""></p><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">global:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> resolve_timeout:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 5m</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> # 邮箱服务器</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> smtp_smarthost:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">smtp.163.com:25</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> smtp_from:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">baojingtongzhi@163.com</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> smtp_auth_username:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">baojingtongzhi@163.com</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> smtp_auth_password:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">xxx</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> smtp_require_tls:</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> false</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 配置路由树</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">route:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> group_by:</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> [‘alertname’] </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 根据告警规则组名进行分组</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> group_wait:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 10s</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> # 分组内第一个告警等待时间，10s内如有第二个告警会合并一个告警</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> group_interval:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 10s</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> # 发送新告警间隔时间</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> repeat_interval:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 1h</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> # 重复告警间隔发送时间</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> receiver:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">mail</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 接收人</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">receivers:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">-</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> name:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">mail</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  email_configs:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  -</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> to:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">zhenliang369@163.com</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># vi prometheus.yml</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 指定Alertmanager组件地址</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">alerting:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  alertmanagers:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  -</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> static_configs:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    -</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> targets:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">      -</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 127.0.0.1:9093</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 执行告警规则</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">rule_files:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  -</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">rules/*.yml</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">  </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># vi rules/general.yml</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">groups:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">-</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> name:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> example</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> #告警规则组名称</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  rules:</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">  # 任何实例5分钟内无法访问发出告警</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  -</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> alert:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> InstanceDown</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> # 告警规则名称</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    expr:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> up</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ==</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 0</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> # 基于PromQL的触发条件</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">    for</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">: 5m </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 等待评估时间</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    labels:</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> # 自定义标签</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">      severity:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> page</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    annotations:</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> # 指定附加信息</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">      summary:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {{ $labels.instance }} 停止工作</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">      description:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">{{ $labels.instance }}：job {{ $labels.job }} 已经停止5分钟以上.</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>告警状态：</p><ul><li><p>Inactive：这里什么都没有发生。</p></li><li><p>Pending：已触发阈值，但未满足告警持续时间</p></li><li><p>Firing：已触发阈值且满足告警持续时间。警报发送给接受者。</p></li></ul><p><img src="`+u+'" alt=""></p><p><img src="'+m+'" alt=""></p><p><img src="'+g+'" alt=""></p><p><img src="'+v+`" alt=""></p><p>小结：</p><p>1.在k8s中部署应用，在service或者pod中配置注解</p><p>annotations:</p><pre><code>  prometheus.io/scrape: &#39;true&#39;
</code></pre><p>2.数据被采集到，可以写任意告警规则，出现问题，第一时间通知你</p><p>3.如果grafana仪表盘无法满足需求，可以自定义</p><p>4.grafana图标没数据，数据没采集到，promq写的有问题，服务器时间没同步</p><p>5.altermanger和prometheus配置文件如果没生效，手动配置热加载</p><p>curl -XPOST 10.244.169.152:9093/-/reload</p><p>curl -XPOST 10.244.26.74:9090/-/reload</p>`,50)]))}const B=a(y,[["render",b],["__file","index.html.vue"]]),E=JSON.parse(`{"path":"/notes/k8s/dxxfsk66/","title":"prometheus监控kubernetes","lang":"zh-CN","frontmatter":{"title":"prometheus监控kubernetes","createTime":"2024/09/29 11:18:34","permalink":"/notes/k8s/dxxfsk66/","head":[["script",{"id":"check-dark-mode"},";(function () {const um= localStorage.getItem('vuepress-theme-appearance') || 'auto';const sm = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;const isDark = um === 'dark' || (um !== 'light' && sm);document.documentElement.dataset.theme = isDark ? 'dark' : 'light';})();"],["script",{"id":"check-mac-os"},"document.documentElement.classList.toggle('mac', /Mac|iPhone|iPod|iPad/i.test(navigator.platform))"]]},"headers":[{"level":2,"title":"Prometheus 介绍","slug":"prometheus-介绍","link":"#prometheus-介绍","children":[]},{"level":2,"title":"Prometheus组件与架构","slug":"prometheus组件与架构","link":"#prometheus组件与架构","children":[]},{"level":2,"title":"Prometheus基本使用：怎么来监控？","slug":"prometheus基本使用-怎么来监控","link":"#prometheus基本使用-怎么来监控","children":[]},{"level":2,"title":"Prometheus基本使用：部署","slug":"prometheus基本使用-部署","link":"#prometheus基本使用-部署","children":[]},{"level":2,"title":"Prometheus基本使用：监控Linux服务器","slug":"prometheus基本使用-监控linux服务器","link":"#prometheus基本使用-监控linux服务器","children":[]},{"level":2,"title":"Prometheus基本使用：查询数据","slug":"prometheus基本使用-查询数据","link":"#prometheus基本使用-查询数据","children":[]},{"level":2,"title":"Kubernetes 监控指标","slug":"kubernetes-监控指标","link":"#kubernetes-监控指标","children":[]},{"level":2,"title":"Kubernetes 监控实现思路","slug":"kubernetes-监控实现思路","link":"#kubernetes-监控实现思路","children":[]},{"level":2,"title":"在Kubernetes平台部署相关组件","slug":"在kubernetes平台部署相关组件","link":"#在kubernetes平台部署相关组件","children":[]},{"level":2,"title":"Prometheus 告警","slug":"prometheus-告警","link":"#prometheus-告警","children":[]}],"readingTime":{"minutes":6.1,"words":1829},"filePathRelative":"notes/k8s/introduction/16.prometheus监控kubernetes.md"}`);export{B as comp,E as data};
