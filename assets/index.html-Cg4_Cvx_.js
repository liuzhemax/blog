import{_ as i,c as e,e as a,o as n}from"./app-D5peQ_E2.js";const t="/images/BE0CAF453EFC4A9C9A313378AEEBB235clipboard.png",l="/images/0529DD2E898E451381DDB87446AA14A4clipboard.png",p="/images/FAFC458BFE1740C2A0E4F06C3CEEFC18clipboard.png",h="/images/92B46314509743E0A2952DAC8E4BA734clipboard.png",r="/images/1376CD2E30B54811A8BA135E48D6576Eclipboard.png",d="/images/A49093752EEA4E17AEA2BBB45BF27EA4clipboard.png",k="/images/9180EE3332F14900A846D466D0E82B3Bclipboard.png",c="/images/3DBD05C59B9F4131934A279BD2D2DF4Fclipboard.png",u="/images/5E920104DEDB44FB82D5CEDAD0EEECD9clipboard.png",b="/images/51C5DE0AF4B14580AEC12BE6F0FC0DF0clipboard.png",o="/images/67162AA145D94B059DEB71CB8C2ED2D5clipboard.png",g="/images/38E535415D414FF997BAC641D66C24BFclipboard.png",v="/images/E513AA60AB32434D92095C3AE79C57BFclipboard.png",A="/images/B85247E5D1CA45FDBB878F0943B22CC4clipboard.png",m={};function y(D,s){return n(),e("div",null,s[0]||(s[0]=[a('<h2 id="kubernetes-容器云平台技术方案" tabindex="-1"><a class="header-anchor" href="#kubernetes-容器云平台技术方案"><span>Kubernetes 容器云平台技术方案</span></a></h2><p><img src="'+t+'" alt=""></p><h3 id="kubernetes-容器云平台技术方案-存储" tabindex="-1"><a class="header-anchor" href="#kubernetes-容器云平台技术方案-存储"><span>Kubernetes 容器云平台技术方案：存储</span></a></h3><p>Ceph是一个高性能的分布式存储系统，提供对象存 储、块存储和文件存储功能，可存储海量数据。 角色：Pod数据持久化存储</p><p><img src="'+l+'" alt=""></p><h3 id="kubernetes-容器云平台技术方案-网络" tabindex="-1"><a class="header-anchor" href="#kubernetes-容器云平台技术方案-网络"><span>Kubernetes 容器云平台技术方案：网络</span></a></h3><p>Calico是一个纯三层的数据中心网络方案，Calico支 持广泛的平台，包括Kubernetes、OpenStack等。 Calico 在每一个计算节点利用 Linux Kernel 实现了 一个高效的虚拟路由器（ vRouter） 来负责数据转发， 而每个 vRouter 通过 BGP 协议负责把自己上运行的 workload 的路由信息向整个 Calico 网络内传播。 此外，Calico 项目还实现了 Kubernetes 网络策略， 提供ACL功能。</p><p><img src="'+p+'" alt=""></p><h3 id="kubernetes-容器云平台技术方案-监控" tabindex="-1"><a class="header-anchor" href="#kubernetes-容器云平台技术方案-监控"><span>Kubernetes 容器云平台技术方案：监控</span></a></h3><p>Prometheus是SoundCloud开源的一款监控 系统。它的实现参考了Google内部的监控系 统，并支持在Kubernetes自动发现被监控端。 是目前Kubernetes监控首选方案。</p><p><img src="'+h+'" alt=""></p><p>Pod</p><p>kubelet的节点使用cAdvisor提供的metrics接口获取该节点所有 Pod和容器相关的性能指标数据。 指标接口：https://NodeIP:10250/metrics/cadvisor</p><p>Node</p><p>使用node_exporter收集器采集节点资源利用率。</p><p>项目地址：https://github.com/prometheus/node_exporter</p><p>K8s资源对象</p><p>kube-state-metrics采集了k8s中各种资源对象的状态信息。 项目地址：https://github.com/kubernetes/kube-state-metrics</p><p><img src="'+r+'" alt=""></p><h3 id="kubernetes-容器云平台技术方案-日志" tabindex="-1"><a class="header-anchor" href="#kubernetes-容器云平台技术方案-日志"><span>Kubernetes 容器云平台技术方案：日志</span></a></h3><p>ELK 是三个开源软件的缩写，提供一套完整的企业级日 志平台解决方案。</p><p>分别是：</p><ul><li><p>Elasticsearch：搜索、分析和存储数据</p></li><li><p>Logstash ：采集日志、格式化、过滤，最后将数据 推送到Elasticsearch存储</p></li><li><p>Kibana：数据可视化</p></li><li><p>Beats ：集合了多种单一用途数据采集器，用于实 现从边缘机器向 Logstash 和 Elasticsearch 发送数 据。里面应用最多的是Filebeat，是一个轻量级日 志采集器。</p></li></ul><p><img src="'+d+'" alt=""></p><p><img src="'+k+'" alt=""></p><h3 id="kubernetes-容器云平台技术方案-ci-cd" tabindex="-1"><a class="header-anchor" href="#kubernetes-容器云平台技术方案-ci-cd"><span>Kubernetes 容器云平台技术方案：CI/CD</span></a></h3><p><img src="'+c+'" alt=""></p><h3 id="其他事项" tabindex="-1"><a class="header-anchor" href="#其他事项"><span>其他事项</span></a></h3><ul><li><p>选择物理机还是虚拟机？</p></li><li><p>Linux操作系统选哪个好</p></li><li><p>内核是否需要升级？</p></li><li><p>使用命名空间隔离环境</p></li><li><p>使用RBAC分配权限</p></li><li><p>对于应用者来说，K8s编排和应用学习成本大，应平台化操作</p></li></ul><h2 id="自动化部署-kubernetes-集群" tabindex="-1"><a class="header-anchor" href="#自动化部署-kubernetes-集群"><span>自动化部署 Kubernetes 集群</span></a></h2><p>有哪些自动化部署工具？</p><p>kubeadm</p><p>https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm/</p><p>kops</p><p>https://kubernetes.io/docs/setup/production-environment/tools/kops/</p><p>https://github.com/kubernetes/kops</p><p>kubespray</p><p>https://kubernetes.io/docs/setup/production-environment/tools/kubespray/</p><p>https://github.com/kubernetes-sigs/kubespray</p><p>Ansible Playbook自动化部署K8s集群：https://gitee.com/lucky_liuzhe/ansible-install-k8s</p><p>为什么自己造轮子？</p><ul><li><p>进一步熟悉k8s</p></li><li><p>方便部署</p></li><li><p>更易于维护</p></li></ul><h2 id="kubernetes-高可用方案" tabindex="-1"><a class="header-anchor" href="#kubernetes-高可用方案"><span>Kubernetes 高可用方案</span></a></h2><ul><li><p>Etcd高可用</p></li><li><p>kube-apiserver高可用</p></li><li><p>kube-controller-manager与kube-scheduler高可用</p></li><li><p>CoreDNS高可用</p></li></ul><p><img src="'+u+`" alt=""></p><h2 id="kubernetes-数据库-etcd-备份与恢复" tabindex="-1"><a class="header-anchor" href="#kubernetes-数据库-etcd-备份与恢复"><span>Kubernetes 数据库 Etcd 备份与恢复</span></a></h2><p>Kubernetes 使用 Etcd 数据库实时存储集群中的数据，安全起见，一定要备份！</p><p>kubeadm部署方式：</p><p>备份：</p><p>1.安装etcdctl命令</p><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">yum</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -y</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> install</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> etcd</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> （里面包含ectdctl客户端命令）</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>2.备份</p><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">ETCDCTL_API</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">3</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> etcdctl</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \\</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">snapshot </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">save</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> snap.db</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \\</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">--endpoints=https://127.0.0.1:2379 </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">--cacert=/etc/kubernetes/pki/etcd/ca.crt </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">--cert=/etc/kubernetes/pki/etcd/server.crt </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">--key=/etc/kubernetes/pki/etcd/server.key</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>恢复：</p><p>1、先暂停kube-apiserver和etcd容器</p><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">mv</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/kubernetes/manifests</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/kubernetes/manifests.bak</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">mv</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /var/lib/etcd/</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /var/lib/etcd.bak</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>2、恢复</p><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">ETCDCTL_API</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">3</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> etcdctl</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \\</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">snapshot </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">restore</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> snap.db</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \\</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">--data-dir=/var/lib/etcd</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>3、启动kube-apiserver和etcd容器</p><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">mv</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/kubernetes/manifests.bak</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/kubernetes/manifests</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>二进制部署方式：</p><p>备份：</p><p>1.备份</p><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">ETCDCTL_API</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">3</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> /opt/etcd/bin/etcdctl</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \\</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">snapshot </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">save</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> snap.db</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \\</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">--endpoints=https://192.168.0.11:2379 </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">--cacert=/opt/etcd/ssl/ca.pem </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">--cert=/opt/etcd/ssl/server.pem </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">--key=/opt/etcd/ssl/server-key.pem</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2.拷贝备份数据到另两个etcd节点</p><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">scp</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> snap.db</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> root@192.168.0.12:~</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">scp</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> snap.db</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> root@192.168.0.13:~</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>恢复：</p><p>1、先暂停kube-apiserver和etcd</p><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#所有master节点操作</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">systemctl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> stop</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kube-apiserver</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#所有etcd节点操作</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">systemctl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> stop</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> etcd</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">mv</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /var/lib/etcd/default.etcd</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /var/lib/etcd/default.etcd.bak</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2、在每个节点上恢复</p><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">ETCDCTL_API</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">3</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> /opt/etcd/bin/etcdctl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> snapshot</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> restore</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> snap.db</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \\</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">--name </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">etcd-1</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \\</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">--initial-cluster=</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">etcd-1=https://192.168.0.11:2380,etcd2=https://192.168.0.12:2380,etcd-3=https://192.168.0.13:2380</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \\</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">--initial-cluster-token=etcd-cluster </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">--initial-advertise-peer-urls=https://192.168.0.11:2380 </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">--data-dir=/var/lib/etcd/default.etcd</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">ETCDCTL_API</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">3</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> /opt/etcd/bin/etcdctl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> snapshot</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> restore</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> snap.db</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \\</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">--name </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">etcd-2</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \\</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">--initial-cluster=</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">etcd-1=https://192.168.0.11:2380,etcd2=https://192.168.0.12:2380,etcd-3=https://192.168.0.13:2380</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \\</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">--initial-cluster-token=etcd-cluster </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">--initial-advertise-peer-urls=https://192.168.0.12:2380 </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">--data-dir=/var/lib/etcd/default.etcd</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">ETCDCTL_API</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">3</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> /opt/etcd/bin/etcdctl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> snapshot</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> restore</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> snap.db</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \\</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">--name </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">etcd-3</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \\</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">--initial-cluster=</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">etcd-1=https://192.168.0.11:2380,etcd2=https://192.168.0.12:2380,etcd-3=https://192.168.0.13:2380</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \\</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">--initial-cluster-token=etcd-cluster </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">--initial-advertise-peer-urls=https://192.168.0.13:2380 </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">--data-dir=/var/lib/etcd/default.etcd</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>3、启动kube-apiserver和etcd</p><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#所有master节点操作</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">systemctl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> start</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kube-apiserver</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#所有etcd节点操作</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">systemctl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> start</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> etcd</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="kubelet-证书自动续签" tabindex="-1"><a class="header-anchor" href="#kubelet-证书自动续签"><span>Kubelet 证书自动续签</span></a></h2><p>K8s证书一般分为两套：K8s组件（apiserver）和Etcd</p><p>假如按角色来分，证书分为管理节点和工作节点。</p><ul><li><p>管理节点：如果是kubeadm部署则自动生成，如果是二进制部署一般由cfssl或者openssl生成。</p></li><li><p>工作节点：工作节点主要是指kubelet连接apiserver所需的客户端证书，这个证书由controller-manager组件自动颁发，默认 是一年，如果到期，kubelet将无法使用过期的证书连接apiserver，从而导致无法正常工作，日志会给出证书过期错误（x509: certificate has expired or is not yet valid）</p></li></ul><p><img src="`+b+`" alt=""></p><p>管理节点：</p><ul><li><p>kube-apiserver （本地访问apiserver:127.0.0.1:8080 远端访问apiserver:IP:6443）</p></li><li><p>controller-manager （可单独部署到其他机器）</p></li><li><p>scheduler （可单独部署到其他机器）</p></li></ul><p>工作节点：</p><ul><li><p>kubelet</p></li><li><p>kube-proxy</p></li></ul><p>#查看证书有效期</p><p>kubeadm alpha certs check-expiration</p><p>kubeadm:</p><p>管理节点：kubeadm alpha certs renew 或者升级k8s版本 kubeadm upgrade</p><p>https://kubernetes.io/zh/docs/tasks/administer-cluster/kubeadm/kubeadm-upgrade/</p><p>工作节点：</p><p>1、配置kube-controller-manager组件</p><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#vim /etc/kubernetes/manifests/kube-controller-manager.yaml </span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">spec:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  containers:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  -</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> command:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    -</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kube-controller-manager</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    -</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --experimental-cluster-signing-duration=87600h0m0s</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    -</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --feature-gates=RotateKubeletServerCertificate=true</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    ...</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>添加上述两个参数：</p><ul><li><p>experimental-cluster-signing-duration=87600h0m0s 为kubelet客户端证书颁发有效期10年</p></li><li><p>feature-gates=RotateKubeletServerCertificate=true 启用server证书颁发</p></li></ul><p>配置完成后，重建pod使之生效：</p><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> delete</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> pod</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kube-controller-manager-k8s-master</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -n</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kube-system</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>2、配置kubelet组件</p><p>默认kubelet证书轮转已启用：</p><p>vi /var/lib/kubelet/config.yaml</p><p><img src="`+o+`" alt=""></p><p>3、测试</p><p>找一台节点测试，先查看现有客户端证书有效期：</p><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">cd</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /var/lib/kubelet/pki/</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">openssl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> x509</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -in</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kubelet-client-current.pem</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -noout</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -dates</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="`+g+`" alt=""></p><p>修改服务器时间，模拟证书即将到期：</p><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">date</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -s</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">2022-2-1</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">systemctl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> restart</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kubelet.service</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>再查看证书有效期，可以看到已经是十年：</p><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">openssl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> x509</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -in</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kubelet-client-current.pem</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -noout</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -dates</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><img src="`+v+`" alt=""></p><p>二进制：</p><p>管理节点：证书自管理</p><p>工作节点：</p><p>找一台节点查看：</p><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># cd /opt/kubernetes/ssl</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># openssl x509 -in kubelet-client-current.pem -noout -dates</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">notBefore</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Aug</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 8</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 15:54:54</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 2020</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> GMT</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> </span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">notAfter</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Aug</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> 7</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 07:38:00</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 2025</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> GMT</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># openssl x509 -in /opt/kubernetes/ssl/ca.pem -noout -dates</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>配置了默认是5年，所以在5年之前不会出现证书过期的问题</p><h2 id="kubernetes-集群常见故障排查思路" tabindex="-1"><a class="header-anchor" href="#kubernetes-集群常见故障排查思路"><span>Kubernetes 集群常见故障排查思路</span></a></h2><p>先区分部署方式：</p><p>1、kubeadm 除kubelet外，其他组件均采用静态Pod启动</p><p>2、二进制 所有组件均采用systemd管理</p><p>集群部署类问题：</p><ul><li><p>网络不通</p></li><li><p>启动失败，一般配置文件或者依赖服务</p></li><li><p>平台不兼容</p></li></ul><p>应用部署类问题：</p><ul><li><p>查看资源详情：kubectl describe TYPE/NAME</p></li><li><p>查看容器日志：kubectl logs TYPE/NAME [-c CONTAINER]</p></li><li><p>进入容器中：kubectl exec POD [-c CONTAINER] -- COMMAND [args...]</p></li></ul><p>网络类问题，一般指无法在集群内部或者外部访问应用：</p><ul><li><p>Pod正常工作吗？</p></li><li><p>Service是否关联Pod？</p></li><li><p>Service指定target-port端口是否正确？</p></li><li><p>如果用名称访问，DNS是否正常工作？</p></li><li><p>kube-proxy正常工作吗？是否正常写iptables规则？</p></li><li><p>CNI网络插件是否正常工作？</p></li></ul><p><img src="`+A+'" alt=""></p>',124)]))}const B=i(m,[["render",y],["__file","index.html.vue"]]),E=JSON.parse(`{"path":"/notes/k8s/dpeuv5bm/","title":"kubernetes运维管理","lang":"zh-CN","frontmatter":{"title":"kubernetes运维管理","createTime":"2024/09/29 12:14:40","permalink":"/notes/k8s/dpeuv5bm/","head":[["script",{"id":"check-dark-mode"},";(function () {const um= localStorage.getItem('vuepress-theme-appearance') || 'auto';const sm = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;const isDark = um === 'dark' || (um !== 'light' && sm);document.documentElement.dataset.theme = isDark ? 'dark' : 'light';})();"],["script",{"id":"check-mac-os"},"document.documentElement.classList.toggle('mac', /Mac|iPhone|iPod|iPad/i.test(navigator.platform))"]]},"headers":[{"level":2,"title":"Kubernetes 容器云平台技术方案","slug":"kubernetes-容器云平台技术方案","link":"#kubernetes-容器云平台技术方案","children":[{"level":3,"title":"Kubernetes 容器云平台技术方案：存储","slug":"kubernetes-容器云平台技术方案-存储","link":"#kubernetes-容器云平台技术方案-存储","children":[]},{"level":3,"title":"Kubernetes 容器云平台技术方案：网络","slug":"kubernetes-容器云平台技术方案-网络","link":"#kubernetes-容器云平台技术方案-网络","children":[]},{"level":3,"title":"Kubernetes 容器云平台技术方案：监控","slug":"kubernetes-容器云平台技术方案-监控","link":"#kubernetes-容器云平台技术方案-监控","children":[]},{"level":3,"title":"Kubernetes 容器云平台技术方案：日志","slug":"kubernetes-容器云平台技术方案-日志","link":"#kubernetes-容器云平台技术方案-日志","children":[]},{"level":3,"title":"Kubernetes 容器云平台技术方案：CI/CD","slug":"kubernetes-容器云平台技术方案-ci-cd","link":"#kubernetes-容器云平台技术方案-ci-cd","children":[]},{"level":3,"title":"其他事项","slug":"其他事项","link":"#其他事项","children":[]}]},{"level":2,"title":"自动化部署 Kubernetes 集群","slug":"自动化部署-kubernetes-集群","link":"#自动化部署-kubernetes-集群","children":[]},{"level":2,"title":"Kubernetes 高可用方案","slug":"kubernetes-高可用方案","link":"#kubernetes-高可用方案","children":[]},{"level":2,"title":"Kubernetes 数据库 Etcd 备份与恢复","slug":"kubernetes-数据库-etcd-备份与恢复","link":"#kubernetes-数据库-etcd-备份与恢复","children":[]},{"level":2,"title":"Kubelet 证书自动续签","slug":"kubelet-证书自动续签","link":"#kubelet-证书自动续签","children":[]},{"level":2,"title":"Kubernetes 集群常见故障排查思路","slug":"kubernetes-集群常见故障排查思路","link":"#kubernetes-集群常见故障排查思路","children":[]}],"readingTime":{"minutes":6.01,"words":1804},"filePathRelative":"notes/k8s/upgrade/1.kubernetes运维管理.md"}`);export{B as comp,E as data};
