import{_ as i,c as a,e as n,o as e}from"./app-D5peQ_E2.js";const l="/images/46FCA6D1D1DE4CB1BF7404E3E644AB9Bclipboard.png",p="/images/D28365050B2C4212BD3B918D4E543123clipboard.png",t="/images/4BC1CA5B289A4AABB644197644BFCF13clipboard.png",h="/images/57A69C2E53F6499B858D3C247528F7B3clipboard.png",k="/images/9D738F0AF4584DA38F71D1BC618DE8ACclipboard.png",d="/images/160A670AE9A44000B53A589FE400605Bclipboard.png",r="/images/D7C5CA3D9A9F4C41BD5E5FFDC2AF08F4clipboard.png",c="/images/57137C13B9A640EE8D7C367E149ADB23clipboard.png",A="/images/45B9E4A9C42543FFAE1E1DBF9241EFDEclipboard.png",g="/images/A0F68B2B033F444B8146083059B79962clipboard.png",v="/images/1423425BFBBC4CF7B8B6547BDB6AA417clipboard.png",y="/images/94448BF326BD473983D7823BCE74D6A2clipboard.png",m="/images/2DC4797D7765429D852EBB7A5E6C32EEclipboard.png",o="/images/31B2F70ADDAD4CA3AED602FECACBBC56clipboard.png",b="/images/3CC81396D80F4171A1FDACC13E9C54D8clipboard.png",u="/images/A3F8D2A415C546398858681A0512333Dclipboard.png",D="/images/9ECAC01183284036B4DFF293FB29FA02clipboard.png",B="/images/C1397ED986B04C628380BEFC3B50A968clipboard.png",C="/images/48DCC6F8FF224A899C3AF23FC8AD0B8Eclipboard.png",E="/images/ECF12D7CD8F145629E5BF72FD6A79F77clipboard.png",P="/images/4C475116BD954880B84C0AD18D7301A2clipboard.png",x="/images/810CBA00E6294D12A8014902A6EC2B6Fclipboard.png",S={};function F(_,s){return e(),a("div",null,s[0]||(s[0]=[n('<h2 id="service是什么与service存在的意义" tabindex="-1"><a class="header-anchor" href="#service是什么与service存在的意义"><span>Service是什么与Service存在的意义</span></a></h2><p>Service引入主要是解决Pod的动态变化，提供统一访问入口：</p><ul><li><p>防止Pod失联，准备找到提供同一个服务的Pod（服务发现）</p></li><li><p>定义一组Pod的访问策略（负载均衡）</p></li></ul><p><img src="'+l+'" alt=""></p><h3 id="pod与service的关系" tabindex="-1"><a class="header-anchor" href="#pod与service的关系"><span>Pod与Service的关系</span></a></h3><ul><li><p>Service通过标签关联一组Pod</p></li><li><p>Service使用iptables或者ipvs为一组Pod提供负载均衡能力</p></li></ul><p><img src="'+p+`" alt=""></p><h3 id="service定义与创建" tabindex="-1"><a class="header-anchor" href="#service定义与创建"><span>Service定义与创建</span></a></h3><p>vim service.yaml</p><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">apiVersion:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> v1</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kind:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> Service</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">metadata:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  labels:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    app:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> web</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  name:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> web</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">spec:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  type</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ClusterIP</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> # 服务类型</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  ports:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  -</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> port:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 80</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> # Service端口</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    protocol:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> TCP</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> # 协议</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    targetPort:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 80</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> # 容器端口</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  selector:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    app:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> web</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> # 指定关联Pod的标签</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#创建service： </span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> apply</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -f</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> service.yaml</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#查看service： </span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> get</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> service</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#查看service关联一组pod的IP</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> get</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> endpoints</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="service三种类型" tabindex="-1"><a class="header-anchor" href="#service三种类型"><span>Service三种类型</span></a></h2><ul><li><p>ClusterIP：集群内部使用</p></li><li><p>NodePort：对外暴露应用（集群外）</p></li><li><p>LoadBalancer：对外暴露应用，适用公有云</p></li></ul><p>ClusterIP：默认，分配一个稳定的IP地址，即VIP，只能在集群内部访问。</p><p>vim service.yaml</p><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">apiVersion:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> v1</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kind:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> Service</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">metadata:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  labels:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    app:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> web</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  name:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> web</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">spec:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  type</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ClusterIP</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> # 服务类型</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  ports:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  -</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> port:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 80</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> # Service端口</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    protocol:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> TCP</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> # 协议</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    targetPort:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 80</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> # 容器端口</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  selector:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    app:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> web</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> # 指定关联Pod的标签</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>访问</p><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> apply</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -f</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> service.yaml</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> </span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> get</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> svc</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">curl</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 10.107.214.48</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    #访问集群内部暴露的service的IP及端口</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="`+t+'" alt=""></p><p><img src="'+h+`" alt=""></p><p>NodePort：在每个节点上启用一个端口来暴露服务，可以在集群 外部访问。也会分配一个稳定内部集群IP地址。 访问地址：&lt;任意NodeIP&gt;: 端口范围：30000-32767</p><p>vim service-node.yaml</p><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">apiVersion:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> v1</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kind:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> Service</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">metadata:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  labels:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    app:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> web</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  name:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> web</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">spec:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  type</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> NodePort</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> # 服务类型</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  ports:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  -</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> port:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 80</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> # Service端口</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    protocol:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> TCP</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> # 协议</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    targetPort:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 80</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> # 容器端口</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    nodePort:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 30009</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    #nodeport暴露的端口</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  selector:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    app:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> web</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> # 指定关联Pod的标签</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>访问</p><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> apply</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -f</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> service-node.yaml</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> </span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> get</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> svc</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">http://192.168.1.12:30009/</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">  #访问集群外部节点IP以及暴露的端口</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="`+k+'" alt=""></p><p><img src="'+d+'" alt=""></p><p>NodePort：会在每台Node上监听端口接收用户流量，在实际情 况下，对用户暴露的只会有一个IP和端口，那这么多台Node该使 用哪台让用户访问呢？</p><p>这时就需要前面加一个公网负载均衡器为项目提供统一访问入口了。</p><p><img src="'+r+`" alt=""></p><p>负载均衡器：</p><ul><li><p>开源：nginx、lvs、haproxy</p></li><li><p>公有云：SLB</p></li></ul><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">upstream</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> demo</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">	server</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 192.168.0.11:30008</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">	server</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 192.168.0.12:30008</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">}</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">upstream</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> demo2</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">	server</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 192.168.0.13:30009</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">	server</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 192.168.0.14:30009</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">}</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">upstream</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> demo3</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">	server</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 192.168.0.15:30010</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">	server</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 192.168.0.16:30010</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">}</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">server</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">	server_name</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> a.xxx.com</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">	location</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">		proxy_pass</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> http://demo</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">	}</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">}</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">server</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">	server_name</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> b.xxx.com</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">	location</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">		proxy_pass</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> http://demo2</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">	}</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">}</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">server</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">	server_name</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> c.xxx.com</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">	location</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">		proxy_pass</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> http://demo3</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">	}</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>LoadBalancer：与NodePort类似，在每个节点上启用一个端口来暴 露服务。除此之外，Kubernetes会请求底层云平台（例如阿里云、腾 讯云、AWS等）上的负载均衡器，将每个Node （[NodeIP]:[NodePort]）作为后端添加进去。</p><p><img src="`+c+'" alt=""></p><h2 id="service代理模式" tabindex="-1"><a class="header-anchor" href="#service代理模式"><span>Service代理模式</span></a></h2><p>Service的底层实现主要有iptables和ipvs二种网络模式，决定了如何转发流量</p><p><img src="'+A+'" alt=""></p><p>基于iptables实现负载均衡的一个过程</p><p>1、在浏览器访问 http://192.168.0.11:30009/</p><p>2.数据包经过iptables规则匹配，重定向到另一个链KUBE-SVC-LOLE4ISW44XBNF3G</p><p>-A KUBE-NODEPORTS -p tcp -m comment --comment &quot;default/web&quot; -m tcp --dport 30009 -j KUBE-SVC-LOLE4ISW44XBNF3G</p><p><img src="'+g+'" alt=""></p><p>3.一组规则，有几个pod就会创建几条规则，这里实现了负载均衡 （概率1/3，1/2，1）</p><p>-A KUBE-SVC-LOLE4ISW44XBNF3G -m comment --comment &quot;default/web&quot; -m statistic --mode random --probability 0.33333333349 -j KUBE-SEP-PXRBKXV7I65SLLDB</p><p>-A KUBE-SVC-LOLE4ISW44XBNF3G -m comment --comment &quot;default/web&quot; -m statistic --mode random --probability 0.50000000000 -j KUBE-SEP-4MXWCRSI3HRHILKZ</p><p>-A KUBE-SVC-LOLE4ISW44XBNF3G -m comment --comment &quot;default/web&quot; -j KUBE-SEP-ODUGDMBPYLOH457E</p><p><img src="'+v+'" alt=""></p><p>4.使用DNAT转发到具体的pod</p><p>-A KUBE-SEP-PXRBKXV7I65SLLDB -p tcp -m comment --comment &quot;default/web&quot; -m tcp -j DNAT --to-destination 10.244.169.133:80</p><p><img src="'+y+'" alt=""></p><p>-A KUBE-SEP-4MXWCRSI3HRHILKZ -p tcp -m comment --comment &quot;default/web&quot; -m tcp -j DNAT --to-destination 10.244.36.67:80</p><p><img src="'+m+'" alt=""></p><p>-A KUBE-SEP-ODUGDMBPYLOH457E -p tcp -m comment --comment &quot;default/web&quot; -m tcp -j DNAT --to-destination 10.244.36.68:80</p><p><img src="'+o+'" alt=""></p><p>针对ClusterIP实现的转发，后面与nodeport一样，回到了上面的第三步</p><p>-A KUBE-SERVICES -d 10.109.90.58/32 -p tcp -m comment --comment &quot;default/web cluster IP&quot; -m tcp --dport 80 -j KUBE-SVC-LOLE4ISW44XBNF3G</p><p><img src="'+b+`" alt=""></p><p>kubeadm方式修改ipvs模式：</p><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> edit</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> configmaps</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kube-proxy</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -n</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kube-system</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#搜索mode，添加ipvs，修改完保存</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  mode:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">ipvs</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#删除node1节点proxy的pod,重新生成新的pod</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> delete</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> pod</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kube-proxy-lzjgg</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -n</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kube-system</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> </span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> get</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> pod</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -o</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> wide</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -n</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kube-system</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> </span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> logs</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kube-proxy-hnw5p</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -n</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kube-system</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="`+u+`" alt=""></p><p>注： 1、kube-proxy配置文件以configmap方式存储 2、如果让所有节点生效，需要重建所有节点kube-proxy pod</p><p>在node1节点上安装ipvsadm工具</p><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">yum</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -y</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> install</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ipvsadm</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">ipvsadm</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -L</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -n</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="`+D+'" alt=""></p><p>ip a</p><p><img src="'+B+'" alt=""></p><p>二进制方式修改ipvs模式：</p><p>vi kube-proxy-config.yml</p><p>mode: ipvs</p><p>ipvs:</p><p>scheduler: &quot;rr“</p><p>systemctl restart kube-proxy</p><p>注：参考不同资料，文件名可能不同</p><p>流程包流程：客户端 -&gt;NodePort/ClusterIP（iptables/Ipvs负载均衡规则） -&gt; 分布在各节点Pod</p><p>查看负载均衡规则：</p><ul><li>iptables模式</li></ul><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">iptables-save</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">grep</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ul><li>ipvs模式</li></ul><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">ipvsadm</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -L</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -n</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><img src="'+C+'" alt=""></p><p>当一个客户端访问service的时候，经过iptables/ipvs进行负载均衡，负载到后端的pod上，iptables/ipvs的规则是由kube-proxy去创建的。</p><p>当出现问题的时候，应该先检查的service的配置的是不是对的（标签端口等等），再检查kube-proxy是不是正常的，有没有创建对应的iptables/ipvs规则。</p><h2 id="service-dns名称" tabindex="-1"><a class="header-anchor" href="#service-dns名称"><span>Service DNS名称</span></a></h2><p>CoreDNS：是一个DNS服务器，Kubernetes默认采用，以Pod部署在集群中，CoreDNS服 务监视Kubernetes API，为每一个Service创建DNS记录用于域名解析。</p><p>CoreDNS YAML文件：</p><p>https://github.com/kubernetes/kubernetes/tree/master/cluster/addons/dns/coredns</p><div class="language- line-numbers-mode" data-ext="" data-title=""><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span>ClusterIP A记录格式：&lt;service-name&gt;.&lt;namespace-name&gt;.svc.cluster.local</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>示例：my-svc.my-namespace.svc.cluster.local</p><p><img src="'+E+'" alt=""></p><p><img src="'+P+`" alt=""></p><p>当我们在pod内做nslookup(dns)解析时，它会请求coredns pod，coredns里面存放了从k8smaster中获取的service对应的dns记录，就会帮你解析成对应service的IP。</p><p>Iptables VS IPVS</p><p>Iptables：</p><ul><li><p>灵活，功能强大</p></li><li><p>规则遍历匹配和更新，呈线性时延</p></li></ul><p>IPVS：</p><ul><li><p>工作在内核态，有更好的性能</p></li><li><p>调度算法丰富：rr，wrr，lc，wlc，ip hash...</p></li></ul><p>生产环境建议使用IPVS</p><p>1、创建一个deployment 副本数 3，然后滚动更新镜像版本，并记录这个更新记录，最后再回滚到上一个版本</p><p>vim web-deployment.yaml</p><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">apiVersion:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> apps/v1</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kind:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> Deployment</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">metadata:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  name:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> web-deployment</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  namespace:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> default</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">spec:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  replicas:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 3</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> # Pod副本预期数量</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  selector:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    matchLabels:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">      app:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> web</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  template:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    metadata:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">      labels:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        app:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> web</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> # Pod副本的标签</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    spec:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">      containers:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">      -</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> name:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> web</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        image:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> nginx:1.15</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> apply</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -f</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> web-deployment.yaml</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#通过命令更新镜像，指定--record参数会将这条命令记录到历史版本记录中，方便回滚到对应的版本</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> set</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> image</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> deploy</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> web-deployment</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> web=nginx:1.16</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --record</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">  </span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> get</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> pod</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -o</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> wide</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">curl</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">  -I10.244.169.140</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">   #验证是否是nginx1.16版本</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> rollout</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> history</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> deployment</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> web-deployment</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">  #查看历史版本记录</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> rollout</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> undo</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> deployment</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> web-deployment</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">  #默认回滚到上一个版本</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> get</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> pod</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -o</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> wide</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    #查看pod的IP</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">curl</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -I</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 10.244.36.76</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">   #验证是否回滚到nginx1.15版本</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2、给一个应用扩容副本数为3</p><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> scale</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> deployment</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> web-deployment</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --replicas=6</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> get</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> pod</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>3、创建一个pod，其中运行着nginx、redis、memcached 3个容器</p><p>vim nginx-redis-memcached.yaml</p><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">apiVersion:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> apps/v1</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kind:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> Deployment</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">metadata:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  name:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> nginx-redis-memcached</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  namespace:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> default</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">spec:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  replicas:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 1</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> # Pod副本预期数量</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  selector:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    matchLabels:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">      app:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> web</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  template:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    metadata:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">      labels:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        app:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> web</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> # Pod副本的标签</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    spec:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">      containers:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">      -</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> name:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> nginx</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        image:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> nginx</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">      containers:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">      -</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> name:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> redis</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        image:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> redis</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">      containers:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">      -</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> name:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> memcached</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        image:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> memcached</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>验证查看</p><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> apply</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -f</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> nginx-redis-memcached.yaml</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> </span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> get</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> pod</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> exec</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -it</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> web-deployment-7c6bf5fdf8-8m2gm</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> nginx</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> bash</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> exec</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -it</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> web-deployment-7c6bf5fdf8-8m2gm</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> redis</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> bash</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> exec</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -it</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> web-deployment-7c6bf5fdf8-8m2gm</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> memcached</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> bash</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>4、给一个pod创建service，并可以通过ClusterIP/NodePort访问</p><p>vim service-node.yaml</p><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">apiVersion:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> v1</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kind:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> Service</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">metadata:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  labels:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    app:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> web</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  name:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> web</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">spec:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  type</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> NodePort</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> # 服务类型</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  ports:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  -</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> port:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 80</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> # Service端口</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    protocol:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> TCP</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> # 协议</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    targetPort:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 80</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> # 容器端口</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    nodePort:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 30009</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    #nodeport暴露的端口</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  selector:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    app:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> web</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> # 指定关联Pod的标签</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>验证查看</p><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> apply</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -f</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> service-node.yaml</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> </span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> get</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> svc</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">curl</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">  -I</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 10.105.40.240</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">   #访问集群内部service IP</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">http://192.168.0.12:30009/</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    #访问任意node节点IP加30009端口</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>5、创建deployment和service，使用busybox容器nslookup解析service</p><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> run</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -it</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> dns-test</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --image=busybox</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> sh</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><img src="`+x+'" alt=""></p><p>注：自由发挥，实现需求即可</p>',118)]))}const I=i(S,[["render",F],["__file","index.html.vue"]]),f=JSON.parse(`{"path":"/notes/k8s/m32l4596/","title":"service对外暴露你的应用","lang":"zh-CN","frontmatter":{"title":"service对外暴露你的应用","createTime":"2024/09/29 10:25:35","permalink":"/notes/k8s/m32l4596/","head":[["script",{"id":"check-dark-mode"},";(function () {const um= localStorage.getItem('vuepress-theme-appearance') || 'auto';const sm = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;const isDark = um === 'dark' || (um !== 'light' && sm);document.documentElement.dataset.theme = isDark ? 'dark' : 'light';})();"],["script",{"id":"check-mac-os"},"document.documentElement.classList.toggle('mac', /Mac|iPhone|iPod|iPad/i.test(navigator.platform))"]]},"headers":[{"level":2,"title":"Service是什么与Service存在的意义","slug":"service是什么与service存在的意义","link":"#service是什么与service存在的意义","children":[{"level":3,"title":"Pod与Service的关系","slug":"pod与service的关系","link":"#pod与service的关系","children":[]},{"level":3,"title":"Service定义与创建","slug":"service定义与创建","link":"#service定义与创建","children":[]}]},{"level":2,"title":"Service三种类型","slug":"service三种类型","link":"#service三种类型","children":[]},{"level":2,"title":"Service代理模式","slug":"service代理模式","link":"#service代理模式","children":[]},{"level":2,"title":"Service DNS名称","slug":"service-dns名称","link":"#service-dns名称","children":[]}],"readingTime":{"minutes":6.55,"words":1965},"filePathRelative":"notes/k8s/introduction/8.service对外暴露你的应用.md"}`);export{I as comp,f as data};
